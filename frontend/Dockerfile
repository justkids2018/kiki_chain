# ä½¿ç”¨æœ¬åœ° nginx:alpine é•œåƒä½œä¸ºåŸºç¡€é•œåƒ
# Alpine Linux æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Linux å‘è¡Œç‰ˆï¼Œé•œåƒå¤§å°çº¦ 5-10MB
# æ”¯æŒ linux/amd64 æ¶æ„ï¼Œé€‚ç”¨äºè…¾è®¯äº‘ç­‰äº‘æœåŠ¡å•†
# ä½¿ç”¨ nginx:alpine ä½œä¸ºåŸºç¡€é•œåƒ - å¼ºåˆ¶ linux/amd64 æ¶æ„
# Alpine Linux æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Linux å‘è¡Œç‰ˆï¼Œé•œåƒå¤§å°çº¦ 5-10MB
# æ˜ç¡®æŒ‡å®š linux/amd64 æ¶æ„ä»¥ç¡®ä¿åœ¨è…¾è®¯äº‘ç­‰ AMD64 æœåŠ¡å™¨ä¸Šè¿è¡Œ
FROM --platform=linux/amd64 nginx:alpine

# ç»´æŠ¤è€…ä¿¡æ¯å’Œé•œåƒå…ƒæ•°æ®
LABEL maintainer="kikichain-team"
LABEL description="å¥‡å¥‡æ¼«æ¸¸è®° Flutter Web åº”ç”¨ - ç”Ÿäº§ç¯å¢ƒé•œåƒ"
LABEL version="1.0.1"
LABEL project="kikichain"
LABEL architecture="linux/amd64"

# è®¾ç½®æ—¶åŒºä¸ºä¸­å›½æ ‡å‡†æ—¶é—´
ENV TZ=Asia/Shanghai

# æ›´æ–°åŒ…ç®¡ç†å™¨å¹¶å®‰è£…å¿…è¦çš„å·¥å…·
# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºåŠ é€Ÿä¸‹è½½ï¼ˆé’ˆå¯¹ä¸­å›½å¤§é™†ç”¨æˆ·ï¼‰
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories && \
    apk update && \
    apk add --no-cache \
        tzdata \
        curl \
        gzip \
        tini && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    rm -rf /var/cache/apk/*

# å¤åˆ¶è‡ªå®šä¹‰ nginx é…ç½®æ–‡ä»¶
# è¿™ä¸ªé…ç½®æ–‡ä»¶åŒ…å«äº†é’ˆå¯¹ Flutter Web åº”ç”¨çš„ä¼˜åŒ–è®¾ç½®
COPY frontend/nginx.conf /etc/nginx/nginx.conf

# å¤åˆ¶ Flutter Web æ„å»ºäº§ç‰©åˆ° nginx é™æ€æ–‡ä»¶ç›®å½•
# build/web/ æ˜¯ Flutter Web æ„å»ºåçš„è¾“å‡ºç›®å½•ï¼ˆæœ¬åœ°å·²æ„å»ºï¼‰
COPY build/web/ /usr/share/nginx/html/

# è®¾ç½® Web æ–‡ä»¶çš„æ­£ç¡®æƒé™
# ç¡®ä¿ nginx ç”¨æˆ·å¯ä»¥è¯»å–æ‰€æœ‰ Web æ–‡ä»¶
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html && \
    test -f /usr/share/nginx/html/index.html || (echo "âŒ é”™è¯¯ï¼šindex.html æ–‡ä»¶ä¸å­˜åœ¨ï¼è¯·å…ˆè¿è¡Œ flutter build web" && exit 1) && \
    test -f /usr/share/nginx/html/main.dart.js || (echo "âŒ é”™è¯¯ï¼šmain.dart.js æ–‡ä»¶ä¸å­˜åœ¨ï¼Flutter æ„å»ºå¯èƒ½å¤±è´¥" && exit 1) && \
    echo "ğŸ“ Web æ–‡ä»¶ç»“æ„ï¼š" && \
    ls -la /usr/share/nginx/html/ && \
    echo "âœ… Flutter Web æ–‡ä»¶éƒ¨ç½²å®Œæˆ"

# åˆ›å»º nginx ç¼“å­˜ç›®å½•
RUN mkdir -p /var/cache/nginx/client_temp \
             /var/cache/nginx/proxy_temp \
             /var/cache/nginx/fastcgi_temp \
             /var/cache/nginx/uwsgi_temp \
             /var/cache/nginx/scgi_temp && \
    chown -R nginx:nginx /var/cache/nginx

# å¥åº·æ£€æŸ¥é…ç½®
# æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œè¶…æ—¶10ç§’ï¼Œå¯åŠ¨5ç§’åå¼€å§‹æ£€æŸ¥ï¼Œè¿ç»­å¤±è´¥3æ¬¡è®¤ä¸ºä¸å¥åº·
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost/ || exit 1

# æš´éœ² HTTP ç«¯å£
EXPOSE 80

# åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·è¿è¡Œï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
USER nginx

# ä½¿ç”¨ tini ä½œä¸ºåˆå§‹åŒ–ç³»ç»Ÿï¼Œç¡®ä¿æ­£ç¡®å¤„ç†ä¿¡å·å’Œåƒµå°¸è¿›ç¨‹
ENTRYPOINT ["/sbin/tini", "--"]

# å¯åŠ¨ Nginx
# daemon off ç¡®ä¿ Nginx åœ¨å‰å°è¿è¡Œï¼Œè¿™æ˜¯ Docker å®¹å™¨çš„è¦æ±‚
CMD ["nginx", "-g", "daemon off;"]
