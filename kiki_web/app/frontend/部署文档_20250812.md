# QiQiManyou Flutter Web 部署文档_20250812

## 📋 项目概览

- **项目名称**: QiQiManyou Flutter Web 应用
- **技术栈**: Flutter Web + Nginx + Docker + PostgreSQL
- **目标环境**: 腾讯云 Linux AMD64
- **域名**: http://keepthinking.me
- **生成时间**: 2025年8月12日
- **特点**: 使用本地 Flutter SDK，无需下载

## 🏗️ 架构说明

```
客户端请求 → 域名解析 → Nginx反向代理 → Flutter Web应用
                                    ↓
                              API请求转发 → 后端服务 → PostgreSQL数据库
```

## 📦 文件结构

```
frontend/
├── Dockerfile                    # 生产环境Docker文件
├── nginx.conf                   # Nginx配置文件
├── docker-compose.yml           # 完整服务编排
├── build_deploy_local.sh        # 一键构建部署脚本
└── docker-exports/              # 镜像导出目录
    ├── kikichain-flutter-web_linux_amd64_*.tar.gz  # 压缩镜像文件
    ├── deploy_to_server.sh       # 服务器部署脚本
    └── upload_to_server.sh       # 上传脚本
```

## 🚀 快速部署流程

### 方式一：一键自动部署（推荐）

```bash
# 1. 进入项目根目录
cd /Users/qisd/Documents/development/qiqimanyouji/kikichain

# 2. 执行一键构建部署脚本
./frontend/build_deploy_local.sh
```

**脚本自动完成以下步骤：**
- ✅ 环境检查（Flutter、Docker）
- ✅ 使用本地Flutter SDK构建Web应用
- ✅ 构建Linux AMD64 Docker镜像
- ✅ 本地测试验证
- ✅ 保存并压缩镜像
- ✅ 生成服务器部署脚本
- ✅ 生成上传命令

### 方式二：手动分步部署

#### 步骤1：本地Flutter构建

```bash
# 安装依赖
flutter pub get

# 构建生产版本
flutter build web --release --web-renderer canvaskit \
  --dart-define=API_BASE_URL=http://keepthinking.me \
  --dart-define=APP_ENV=production
```

#### 步骤2：构建Docker镜像

```bash
# 构建支持Linux AMD64的镜像
docker build --platform linux/amd64 \
  --tag kikichain-flutter-web:latest \
  --file frontend/Dockerfile .
```

#### 步骤3：保存镜像

```bash
# 创建导出目录
mkdir -p frontend/docker-exports

# 保存并压缩镜像
docker save kikichain-flutter-web:latest | \
  gzip > frontend/docker-exports/kikichain-flutter-web_$(date +%Y%m%d_%H%M%S).tar.gz
```

## 🌐 服务器部署

### 1. 上传文件到腾讯云服务器

```bash
# 方式一：使用生成的上传脚本
./frontend/docker-exports/upload_to_server.sh

# 方式二：手动上传
SERVER_USER="root"
SERVER_HOST="keepthinking.me"
SERVER_PATH="/opt/kikichain"

# 上传镜像文件
scp frontend/docker-exports/kikichain-flutter-web_*.tar.gz \
  ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/

# 上传部署脚本
scp frontend/docker-exports/deploy_to_server.sh \
  ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/

# 上传配置文件
scp frontend/docker-compose.yml ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
```

### 2. 服务器端部署

```bash
# 连接到腾讯云服务器
ssh root@keepthinking.me

# 进入项目目录
cd /opt/kikichain

# 执行部署脚本
chmod +x deploy_to_server.sh
./deploy_to_server.sh
```

### 3. 使用Docker Compose部署完整服务栈

```bash
# 在服务器上使用docker-compose部署
cd /opt/kikichain
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f flutter-web
```

## 🔧 配置说明

### Docker镜像特性

- **基础镜像**: nginx:alpine (轻量级，安全)
- **架构支持**: linux/amd64
- **时区**: Asia/Shanghai
- **运行用户**: nginx (非root用户)
- **健康检查**: 30秒间隔检查
- **端口**: 80 (HTTP)

### Nginx配置特性

- **静态文件服务**: 高效的静态资源托管
- **反向代理**: API请求转发到后端服务
- **缓存策略**: 静态资源长期缓存
- **压缩**: Gzip压缩减少传输大小
- **安全头部**: XSS保护、内容类型保护等
- **SPA支持**: 单页应用路由支持

### Docker Compose服务

1. **flutter-web**: 前端Web服务 (端口80)
2. **kikichain-server**: 后端API服务 (端口8001)
3. **postgres**: PostgreSQL数据库 (端口5432)

## 🔍 监控和故障排除

### 健康检查

```bash
# 检查所有容器状态
docker ps

# 检查特定容器
docker ps | grep kikichain

# 检查应用响应
curl -I http://keepthinking.me/

# 查看容器日志
docker logs kikichain-production-frontend
```

### 常见问题解决

#### 1. 容器启动失败

```bash
# 查看详细日志
docker logs --details kikichain-production-frontend

# 检查镜像是否存在
docker images | grep kikichain-flutter-web

# 重新加载镜像
docker load < kikichain-flutter-web_*.tar.gz
```

#### 2. Flutter构建失败

```bash
# 检查Flutter环境
flutter doctor

# 清理构建缓存
flutter clean
flutter pub get

# 重新构建
flutter build web --release
```

#### 3. 网络连接问题

```bash
# 检查端口占用
netstat -tlnp | grep :80

# 检查防火墙设置
ufw status

# 检查Docker网络
docker network ls
docker network inspect kikichain-network
```

#### 4. 权限问题

```bash
# 检查文件权限
ls -la /usr/share/nginx/html/

# 修复权限
docker exec kikichain-production-frontend \
  chown -R nginx:nginx /usr/share/nginx/html
```

## 📊 性能优化

### 1. 镜像优化

- ✅ 使用多阶段构建 (如需要)
- ✅ 使用alpine基础镜像
- ✅ 最小化镜像层数
- ✅ 清理构建缓存

### 2. Nginx优化

- ✅ 启用gzip压缩
- ✅ 配置适当的缓存策略
- ✅ 优化worker进程配置
- ✅ 启用HTTP/2 (如配置SSL)

### 3. Flutter Web优化

- ✅ 使用CanvasKit渲染器
- ✅ 启用Tree Shaking
- ✅ 压缩资源文件
- ✅ 配置适当的缓存头

## 🔒 安全配置

### 1. Nginx安全头部

```nginx
add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";
add_header X-XSS-Protection "1; mode=block";
add_header Referrer-Policy "strict-origin-when-cross-origin";
```

### 2. Docker安全

- ✅ 使用非root用户运行
- ✅ 最小权限原则
- ✅ 定期更新基础镜像
- ✅ 扫描镜像漏洞

### 3. 网络安全

- ✅ 配置防火墙规则
- ✅ 使用私有网络
- ✅ 定期更新SSL证书 (如配置HTTPS)

## 📈 扩展和维护

### 1. 水平扩展

```yaml
# docker-compose.yml扩展配置
flutter-web:
  deploy:
    replicas: 3
    update_config:
      parallelism: 1
      delay: 10s
```

### 2. 持续部署

```bash
#!/bin/bash
# 自动化部署脚本
git pull origin main
./frontend/build_deploy_local.sh
```

### 3. 备份策略

```bash
# 镜像备份
docker save kikichain-flutter-web:latest | \
  gzip > backup/kikichain-$(date +%Y%m%d).tar.gz

# 配置文件备份
tar -czf backup/configs-$(date +%Y%m%d).tar.gz \
  frontend/nginx.conf frontend/docker-compose.yml
```

## 🎯 验证部署成功

### 1. 功能验证

```bash
# 主页访问测试
curl -v http://keepthinking.me/

# 健康检查测试
docker exec kikichain-production-frontend curl -f http://localhost/

# API代理测试
curl -v http://keepthinking.me/api/health
```

### 2. 性能验证

```bash
# 响应时间测试
curl -w "连接时间: %{time_connect}s, 总时间: %{time_total}s\n" \
  -o /dev/null -s http://keepthinking.me/

# 压缩测试
curl -H "Accept-Encoding: gzip" -I http://keepthinking.me/
```

## 📞 技术支持

### 关键文件位置

- **项目根目录**: `/Users/qisd/Documents/development/qiqimanyouji/kikichain`
- **构建脚本**: `frontend/build_deploy_local.sh`
- **配置文件**: `frontend/nginx.conf`, `frontend/docker-compose.yml`
- **部署文档**: `frontend/部署文档_20250812.md`

### 环境要求

- **本地环境**: macOS + Flutter 3.7.12 + Docker Desktop
- **服务器环境**: Ubuntu/Debian + Docker + Docker Compose
- **网络要求**: 支持SSH连接和HTTP访问

### 紧急处理

如遇紧急问题，请检查以下文档：
- `EMERGENCY_FIX_GUIDE.md`
- `PROBLEM_SOLVED.md`
- Docker日志: `docker logs kikichain-production-frontend`

---

**部署完成后访问地址**: http://keepthinking.me

**文档版本**: v1.0.0  
**最后更新**: 2025年8月12日  
**适用环境**: 腾讯云生产环境 (Linux AMD64)
