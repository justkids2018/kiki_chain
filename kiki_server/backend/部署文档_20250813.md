# 🚀 Rust + Tokio 后端服务生产环境部署文档

> **生成时间**: 2025-08-13  
> **项目**: qiqimanyou_server  
> **架构**: linux/amd64  
> **服务器**: 腾讯云 Ubuntu 22.04  

## 📋 部署概览

### 🎯 部署目标
- **后端服务**: Rust + Tokio (Axum)
- **数据库**: PostgreSQL 15
- **缓存**: Redis 7 (可选)
- **反向代理**: Nginx (前端已配置)

### 🏗️ 架构设计
```
Internet → Nginx (前端) → qiqimanyou-server → PostgreSQL
                     ↘ Redis (可选)
```

## 🚀 快速部署

### 1. 一键部署（推荐）
```bash
# 赋予执行权限
chmod +x backend/deploy_all.sh

# 执行一键部署
./backend/deploy_all.sh
```

### 2. 分步部署

#### 步骤 1：构建镜像
```bash
chmod +x backend/build_image.sh
./backend/build_image.sh
```

#### 步骤 2：部署到服务器
```bash
chmod +x backend/deploy_to_server.sh
./backend/deploy_to_server.sh
```

## 📁 文件结构

```
backend/
├── Dockerfile                 # 多阶段构建文件
├── docker-compose.yml         # 服务编排配置
├── .env.production            # 生产环境变量
├── build_image.sh             # 镜像构建脚本
├── deploy_to_server.sh        # 服务器部署脚本
├── deploy_all.sh              # 一键部署脚本
└── sql/                       # 数据库初始化脚本
```

## ⚙️ 配置说明

### 环境变量配置
编辑 `backend/.env.production` 文件：

```bash
# 数据库配置
POSTGRES_PASSWORD=your_secure_password
JWT_SECRET=your_jwt_secret_key

# 服务器配置
SERVER_HOST=82.156.34.186
SERVER_USER=ubuntu
```

### 网络配置
- **网络名称**: `qiqimanyou-network`
- **后端端口**: 8001 (仅内网)
- **数据库端口**: 5432 (仅内网)
- **Redis 端口**: 6379 (仅内网)

## 🔍 部署验证

### 1. 健康检查
```bash
curl http://82.156.34.186/health
```

### 2. 服务状态
```bash
ssh ubuntu@82.156.34.186 'cd ~/qisd_eda_college/backend && docker compose ps'
```

### 3. 查看日志
```bash
ssh ubuntu@82.156.34.186 'cd ~/qisd_eda_college/backend && docker compose logs -f'
```

## 🛠️ 管理命令

### 服务管理
```bash
# 查看服务状态
docker compose ps

# 重启服务
docker compose restart

# 停止服务
docker compose down

# 启动服务
docker compose up -d

# 查看实时日志
docker compose logs -f qiqimanyou-server
```

### 镜像管理
```bash
# 查看镜像
docker images | grep qiqimanyou

# 清理未使用镜像
docker system prune -f

# 删除特定镜像
docker rmi qiqimanyou-server:latest
```
### 端口管理

```
lsof -i :8000

kill -9 <PID>

```

## ⚠️ 注意事项

### 🔒 安全配置
1. **修改默认密码**: 生产环境必须修改 JWT_SECRET 和数据库密码
2. **防火墙设置**: 确保只开放必要端口 (80, 443)
3. **SSL 证书**: 建议配置 HTTPS (在前端 Nginx 层)

### 📦 镜像优化
1. **多阶段构建**: 已使用 builder + runtime 模式
2. **镜像大小**: 使用 debian:bookworm-slim 基础镜像
3. **缓存优化**: 依赖项单独构建，利用 Docker 缓存

### 🔧 性能调优
1. **内存限制**: 可在 docker-compose.yml 中设置内存限制
2. **日志管理**: 配置日志轮转避免磁盘占满
3. **健康检查**: 已配置应用级健康检查

### 🚨 故障排查
1. **构建失败**: 检查 Rust 代码编译错误
2. **启动失败**: 查看容器日志排查配置问题
3. **网络问题**: 确认网络配置和端口映射
4. **数据库连接**: 检查数据库服务状态和连接字符串

## 📊 监控建议

### 应用监控
- 健康检查端点: `/health`
- 指标收集: 可集成 Prometheus
- 日志聚合: 建议使用 ELK Stack

### 资源监控
- CPU/内存使用率
- 磁盘空间监控
- 网络流量监控

## 🔄 更新部署

### 代码更新
```bash
# 拉取最新代码
git pull origin main

# 重新部署
./backend/deploy_all.sh
```

### 数据库迁移
```bash
# 备份数据库
docker exec qiqimanyou-postgres pg_dump -U qisd edadb > backup.sql

# 执行迁移脚本
# (根据具体迁移需求)
```

## 📞 技术支持

遇到问题时，请提供以下信息：
1. 错误日志: `docker compose logs`
2. 服务状态: `docker compose ps`
3. 系统资源: `free -h && df -h`
4. 网络连接: `netstat -tlnp`

---

📝 **文档维护**: 请在每次重大更新后同步更新此文档  
🔗 **相关文档**: [API 文档] | [数据库设计] | [前端部署]
