# 学生作业记录分数功能 - 实现说明

## 功能概述

已成功实现学生作业记录分数功能，包括：

1. **缓存系统**：点击作业卡片时将学生作业记录缓存
2. **聊天集成**：进入聊天时可根据assignmentId获取记录
3. **评估指标更新**：聊天返回结果时自动更新evaluation_metrics

## 实现的组件

### 1. StudyTaskController 缓存功能

```dart
/// 学生作业记录缓存 - key: assignmentId, value: StudentAssignmentEntity
final RxMap<String, StudentAssignmentEntity> _assignmentRecordCache = 
    <String, StudentAssignmentEntity>{}.obs;

/// 缓存学生作业记录
void cacheAssignmentRecord(String assignmentId, StudentAssignmentEntity record)

/// 根据作业ID获取缓存的学生作业记录
StudentAssignmentEntity? getCachedAssignmentRecord(String assignmentId)

/// 更新缓存中的评估指标
void updateCachedEvaluationMetrics(String assignmentId, Map<String, dynamic> metrics)

/// 提交更新评估指标到服务器
Future<void> submitEvaluationMetricsUpdate(String assignmentId)
```

### 2. AssignmentEvaluationService 独立服务

```dart
/// 处理聊天返回结果中的评估指标
void handleChatResponse(String assignmentId, Map<String, dynamic> responseData)

/// 获取指定作业的缓存记录
dynamic getCachedAssignmentRecord(String assignmentId)

/// 手动更新评估指标
void updateEvaluationMetrics(String assignmentId, Map<String, dynamic> metrics)
```

### 3. AssignmentEvaluationUtils 工具类

```dart
/// 处理聊天响应中的评估指标
static void processChatResponse(String? assignmentId, Map<String, dynamic>? chatResponse)

/// 获取缓存的作业记录
static dynamic getAssignmentRecord(String? assignmentId)

/// 手动更新评估指标
static void updateEvaluationMetrics({
  required String? assignmentId,
  double? twoStudentChain,
  double? twoCoverRate,
  double? threeStudentRate,
  double? threePropositionQuality,
})

/// 从响应数据中提取并更新评估指标
static void extractAndUpdateMetrics(String? assignmentId, Map<String, dynamic>? responseData)
```

### 4. ChatDifyController 集成

- 在聊天消息结束时自动调用评估指标处理
- 通过 `_handleEvaluationMetrics` 方法处理evaluation_metrics更新

## 工作流程

### 1. 点击作业卡片流程

```
用户点击作业卡片
    ↓
调用 _manageStudentAssignmentRecord()
    ↓
查询/创建/更新学生作业记录
    ↓
将记录存入缓存 (assignmentId -> StudentAssignmentEntity)
    ↓
进入聊天页面（传递assignmentId）
```

### 2. 聊天评估指标更新流程

```
聊天接收到响应
    ↓
_handleStreamEvent() 处理 message_end 事件
    ↓
_handleEvaluationMetrics() 提取评估指标
    ↓
AssignmentEvaluationUtils.processChatResponse()
    ↓
更新缓存中的 evaluation_metrics
    ↓
submitEvaluationMetricsUpdate() 提交到服务器
```

## 支持的评估指标

根据API文档，支持以下四个评估指标：

- `two_student_chain`: 二重学生链
- `two_cover_rate`: 二重覆盖率  
- `three_student_rate`: 三重学生率
- `three_proposition_quality`: 三重命题质量

## 使用示例

### 手动更新评估指标

```dart
// 在聊天过程中手动更新评估指标
AssignmentEvaluationUtils.updateEvaluationMetrics(
  assignmentId: "assignment_123",
  twoStudentChain: 0.85,
  twoCoverRate: 0.78,
  threeStudentRate: 0.90,
  threePropositionQuality: 0.88,
);
```

### 获取缓存的作业记录

```dart
// 获取缓存的作业记录
final record = AssignmentEvaluationUtils.getAssignmentRecord("assignment_123");
if (record != null) {
  print("Found cached record: ${record.toString()}");
}
```

### 处理聊天响应

```dart
// 聊天响应处理（自动调用）
final chatResponse = {
  "two_student_chain": 0.85,
  "two_cover_rate": 0.78,
  "three_student_rate": 0.90,
  "three_proposition_quality": 0.88,
  // ... 其他聊天响应数据
};

AssignmentEvaluationUtils.processChatResponse("assignment_123", chatResponse);
```

## 特性

- **功能独立性**：完全独立的模块，不影响现有聊天功能
- **自动化**：聊天过程中自动处理评估指标更新
- **缓存机制**：高效的内存缓存，避免重复API调用
- **错误处理**：完善的错误处理和日志记录
- **API兼容**：完全兼容后端API文档定义的数据结构

## 日志记录

所有操作都有详细的日志记录，便于调试和监控：

- 缓存操作日志
- 评估指标更新日志
- API调用成功/失败日志
- 错误处理日志

## 调试验证

可以通过以下日志关键词查看功能运行状态：

- `"Cached assignment record for assignment"`
- `"Retrieved cached assignment record for assignment"`
- `"Updated cached evaluation metrics for assignment"`
- `"Successfully submitted evaluation metrics update"`
- `"Processing chat response for assignment"`
- `"Extracted evaluation metrics"`