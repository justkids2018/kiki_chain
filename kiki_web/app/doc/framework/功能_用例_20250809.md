# Flutter Clean Architecture åŠŸèƒ½ç”¨ä¾‹æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025å¹´8æœˆ9æ—¥  
**æœ€åä¿®æ”¹**: 2025å¹´8æœˆ9æ—¥  
**ç‰ˆæœ¬**: v1.0.0

## æ›´æ”¹è®°å½•

| æ—¶é—´ | ç‰ˆæœ¬ | ä¿®æ”¹å†…å®¹ | ä¿®æ”¹äºº |
|------|------|----------|--------|
| 2025-08-09 | v1.0.0 | åˆå§‹åŠŸèƒ½ç”¨ä¾‹æ–‡æ¡£åˆ›å»º | Flutteræ¶æ„å¸ˆ |

---

## 1. åº”ç”¨åˆå§‹åŒ–ç”¨ä¾‹

### 1.1 åº”ç”¨å¯åŠ¨æµç¨‹

```dart
// main.dart
void main() async {
  // åˆå§‹åŒ–åº”ç”¨ç¨‹åº
  await AppInitializer.initialize();
  
  // è¿è¡Œåº”ç”¨
  runApp(MyApp());
}
```

### 1.2 ç¯å¢ƒé…ç½®ç”¨ä¾‹

```dart
// å¼€å‘ç¯å¢ƒåˆå§‹åŒ–
await EnvConfig.load('dev');  // åŠ è½½ config/dev.env

// è®¿é—®é…ç½®
String apiUrl = EnvConfig.apiBaseUrl;
bool enableLogging = EnvConfig.enableLogging;
int timeout = EnvConfig.connectTimeout;
```

**ç¯å¢ƒé…ç½®æ–‡ä»¶ç¤ºä¾‹ (config/dev.env):**
```properties
API_BASE_URL=http://127.0.0.1:8080
ENV_TYPE=dev
DEBUG=true
ENABLE_LOGGING=true
CONNECT_TIMEOUT=30000
RECEIVE_TIMEOUT=30000
SEND_TIMEOUT=30000
ENABLE_CACHE=true
CACHE_EXPIRE_MINUTES=5
MAX_RETRY_COUNT=3
APP_NAME=å¥‡å¥‡æ¼«æ¸¸è®°
DEFAULT_PAGE_SIZE=20
```

---

## 2. ç½‘ç»œå±‚ç”¨ä¾‹

### 2.1 åŸºç¡€ç½‘ç»œè¯·æ±‚

```dart
class UserService {
  final RequestManager _request = RequestManager.instance;
  
  /// è·å–ç”¨æˆ·åˆ—è¡¨
  Future<List<Map<String, dynamic>>> getUsers() async {
    try {
      final data = await _request.get<Map<String, dynamic>>('/users');
      return List<Map<String, dynamic>>.from(data['data'] ?? []);
    } catch (e) {
      AppLogger.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: $e');
      return [];
    }
  }
  
  /// åˆ›å»ºç”¨æˆ·
  Future<Map<String, dynamic>?> createUser(Map<String, dynamic> userData) async {
    try {
      final response = await _request.post<Map<String, dynamic>>(
        '/users',
        data: userData,
      );
      return response['data'];
    } catch (e) {
      AppLogger.error('åˆ›å»ºç”¨æˆ·å¤±è´¥: $e');
      return null;
    }
  }
  
  /// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  Future<bool> updateUser(int userId, Map<String, dynamic> userData) async {
    try {
      await _request.put<Map<String, dynamic>>(
        '/users/$userId',
        data: userData,
      );
      return true;
    } catch (e) {
      AppLogger.error('æ›´æ–°ç”¨æˆ·å¤±è´¥: $e');
      return false;
    }
  }
  
  /// åˆ é™¤ç”¨æˆ·
  Future<bool> deleteUser(int userId) async {
    try {
      await _request.delete<Map<String, dynamic>>('/users/$userId');
      return true;
    } catch (e) {
      AppLogger.error('åˆ é™¤ç”¨æˆ·å¤±è´¥: $e');
      return false;
    }
  }
}
```

### 2.2 æ–‡ä»¶ä¸Šä¼ ç”¨ä¾‹

```dart
class FileService {
  final RequestManager _request = RequestManager.instance;
  
  /// ä¸Šä¼ å•ä¸ªæ–‡ä»¶
  Future<String?> uploadFile(File file) async {
    try {
      final fileName = file.path.split('/').last;
      final formData = FormData.fromMap({
        'file': await MultipartFile.fromFile(
          file.path,
          filename: fileName,
        ),
      });
      
      final response = await _request.upload<Map<String, dynamic>>(
        ApiEndpoints.uploadFile,
        formData,
        onSendProgress: (int sent, int total) {
          final progress = (sent / total * 100).toStringAsFixed(1);
          AppLogger.info('ä¸Šä¼ è¿›åº¦: $progress%');
        },
      );
      
      return response['data']['url'];
    } catch (e) {
      AppLogger.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: $e');
      return null;
    }
  }
  
  /// ä¸‹è½½æ–‡ä»¶
  Future<bool> downloadFile(String url, String savePath) async {
    try {
      await _request.download(
        url,
        savePath,
        onReceiveProgress: (int received, int total) {
          if (total != -1) {
            final progress = (received / total * 100).toStringAsFixed(1);
            AppLogger.info('ä¸‹è½½è¿›åº¦: $progress%');
          }
        },
      );
      return true;
    } catch (e) {
      AppLogger.error('æ–‡ä»¶ä¸‹è½½å¤±è´¥: $e');
      return false;
    }
  }
}
```

### 2.3 è®¤è¯ç®¡ç†ç”¨ä¾‹

```dart
class AuthRepository {
  final RequestManager _requestManager = RequestManager.instance;
  
  get _localStorage => AppServices.instance.localStorage;
  
  /// ç”¨æˆ·ç™»å½•
  Future<User?> login(String username, String password) async {
    try {
      final response = await _requestManager.post<Map<String, dynamic>>(
        ApiEndpoints.authLogin,
        data: {
          'username': username,
          'password': password,
        },
      );
      
      if (response['data'] != null) {
        final data = response['data'];
        
        // å­˜å‚¨token
        if (data['token'] != null) {
          await _localStorage.setAccessToken(data['token']);
          _requestManager.setAuthToken(data['token']); // è®¾ç½®åˆ°ç½‘ç»œå±‚
        }
        
        // å­˜å‚¨åˆ·æ–°token
        if (data['refresh_token'] != null) {
          await _localStorage.setRefreshToken(data['refresh_token']);
        }
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        if (data['user'] != null) {
          final user = User.fromJson(data['user']);
          await _localStorage.setUserId(user.id);
          await _localStorage.setUserInfo(user.toJson());
          
          AppLogger.info('User logged in successfully: ${user.username}');
          return user;
        }
      }
      
      return null;
    } catch (e) {
      AppLogger.error('Login failed', e);
      rethrow;
    }
  }
  
  /// é€€å‡ºç™»å½•
  Future<void> logout() async {
    try {
      await _requestManager.post<Map<String, dynamic>>(
        ApiEndpoints.authLogout,
      );
    } catch (e) {
      AppLogger.warning('Logout request failed: $e');
    } finally {
      // æ¸…é™¤æœ¬åœ°æ•°æ®
      await _localStorage.clearAuthData();
      _requestManager.clearAuthToken();
    }
  }
  
  /// åˆ·æ–°Token
  Future<String?> refreshToken() async {
    try {
      final refreshToken = await _localStorage.getRefreshToken();
      if (refreshToken == null) return null;
      
      final response = await _requestManager.post<Map<String, dynamic>>(
        ApiEndpoints.authRefresh,
        data: {'refresh_token': refreshToken},
      );
      
      final newToken = response['data']['token'];
      if (newToken != null) {
        await _localStorage.setAccessToken(newToken);
        _requestManager.setAuthToken(newToken);
        return newToken;
      }
      
      return null;
    } catch (e) {
      AppLogger.error('Token refresh failed: $e');
      return null;
    }
  }
}
```

---

## 3. æœåŠ¡ç®¡ç†ç”¨ä¾‹

### 3.1 æœåŠ¡è®¿é—®æ¨¡å¼

```dart
class HomeController extends GetxController {
  // ç›´æ¥ä»AppServicesè·å–æœåŠ¡å®ä¾‹
  get _authRepository => AppServices.instance.authRepository;
  get _userService => AppServices.instance.userService;
  get _localStorage => AppServices.instance.localStorage;
  
  final Rxn<User> currentUser = Rxn<User>();
  
  @override
  void onInit() {
    super.onInit();
    _loadUserInfo();
  }
  
  /// åŠ è½½ç”¨æˆ·ä¿¡æ¯
  void _loadUserInfo() async {
    try {
      // ä»è®¤è¯ä»“åº“è·å–å½“å‰ç”¨æˆ·
      final user = await _authRepository.getCurrentUser();
      currentUser.value = user;
    } catch (e) {
      AppLogger.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥: $e');
    }
  }
  
  /// ç”¨æˆ·ç™»å‡º
  void logout() async {
    try {
      await _authRepository.logout();
      currentUser.value = null;
      Get.offAllNamed('/login');
    } catch (e) {
      AppLogger.error('ç”¨æˆ·ç™»å‡ºå¤±è´¥: $e');
    }
  }
}
```

### 3.2 æœåŠ¡åˆå§‹åŒ–ç”¨ä¾‹

```dart
class AppServices {
  /// åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
  Future<void> initialize() async {
    if (_initialized) {
      AppLogger.info('ğŸ”„ åº”ç”¨æœåŠ¡å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
      return;
    }
    
    AppLogger.info('ğŸš€ å¼€å§‹åˆå§‹åŒ–åº”ç”¨æœåŠ¡...');
    
    try {
      // 1. åˆå§‹åŒ–ç¯å¢ƒé…ç½®
      await EnvConfig.load('dev');
      AppLogger.info('âœ… ç¯å¢ƒé…ç½®åˆå§‹åŒ–å®Œæˆ');
      
      // 2. åˆå§‹åŒ–ç½‘ç»œå±‚
      ApiConfig.initDev();
      AppLogger.info('âœ… ç½‘ç»œå±‚åˆå§‹åŒ–å®Œæˆ');
      
      // 3. åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨æœåŠ¡
      _localStorage = LocalStorageService();
      await _localStorage!.onInit();
      AppLogger.info('âœ… æœ¬åœ°å­˜å‚¨æœåŠ¡åˆå§‹åŒ–å®Œæˆ');
      
      // 4. åˆå§‹åŒ–ä¸šåŠ¡æœåŠ¡ï¼ˆæ‡’åŠ è½½ï¼Œä½¿ç”¨æ—¶å†åˆ›å»ºï¼‰
      AppLogger.info('âœ… ä¸šåŠ¡æœåŠ¡å‡†å¤‡å®Œæˆï¼ˆæ‡’åŠ è½½ï¼‰');
      
      _initialized = true;
      AppLogger.info('ğŸ‰ åº”ç”¨æœåŠ¡åˆå§‹åŒ–å®Œæˆ');
      
    } catch (e, stackTrace) {
      AppLogger.error('âŒ åº”ç”¨æœåŠ¡åˆå§‹åŒ–å¤±è´¥: $e');
      AppLogger.error('å †æ ˆè·Ÿè¸ª: $stackTrace');
      rethrow;
    }
  }
}
```

---

## 4. æœ¬åœ°å­˜å‚¨ç”¨ä¾‹

### 4.1 åŸºç¡€å­˜å‚¨æ“ä½œ

```dart
class SettingsController extends GetxController {
  get _localStorage => AppServices.instance.localStorage;
  
  /// ä¿å­˜ç”¨æˆ·è®¾ç½®
  Future<void> saveUserSettings(UserSettings settings) async {
    try {
      await _localStorage.setString('user_settings', jsonEncode(settings.toJson()));
      await _localStorage.setBool('notifications_enabled', settings.notificationsEnabled);
      await _localStorage.setString('language', settings.language);
    } catch (e) {
      AppLogger.error('ä¿å­˜è®¾ç½®å¤±è´¥: $e');
    }
  }
  
  /// è¯»å–ç”¨æˆ·è®¾ç½®
  Future<UserSettings?> loadUserSettings() async {
    try {
      final settingsJson = _localStorage.getString('user_settings');
      if (settingsJson != null) {
        final Map<String, dynamic> data = jsonDecode(settingsJson);
        return UserSettings.fromJson(data);
      }
    } catch (e) {
      AppLogger.error('è¯»å–è®¾ç½®å¤±è´¥: $e');
    }
    return null;
  }
  
  /// æ¸…é™¤ç”¨æˆ·æ•°æ®
  Future<void> clearUserData() async {
    try {
      await _localStorage.clearAuthData();
      await _localStorage.remove('user_settings');
      await _localStorage.remove('cache_data');
    } catch (e) {
      AppLogger.error('æ¸…é™¤æ•°æ®å¤±è´¥: $e');
    }
  }
}
```

### 4.2 å®‰å…¨å­˜å‚¨ç”¨ä¾‹

```dart
class TokenManager {
  get _localStorage => AppServices.instance.localStorage;
  
  /// å­˜å‚¨æ•æ„ŸToken
  Future<void> storeSecureToken(String token) async {
    try {
      await _localStorage.setAccessToken(token);  // ä½¿ç”¨å®‰å…¨å­˜å‚¨
      AppLogger.info('Tokenå·²å®‰å…¨å­˜å‚¨');
    } catch (e) {
      AppLogger.error('Tokenå­˜å‚¨å¤±è´¥: $e');
    }
  }
  
  /// è·å–Token
  Future<String?> getSecureToken() async {
    try {
      return await _localStorage.getAccessToken();
    } catch (e) {
      AppLogger.error('Tokenè·å–å¤±è´¥: $e');
      return null;
    }
  }
  
  /// æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨
  Future<bool> hasValidToken() async {
    final token = await getSecureToken();
    return token != null && token.isNotEmpty;
  }
}
```

---

## 5. é”™è¯¯å¤„ç†ç”¨ä¾‹

### 5.1 ç½‘ç»œé”™è¯¯å¤„ç†

```dart
class ApiService {
  final RequestManager _request = RequestManager.instance;
  
  /// å¸¦é”™è¯¯å¤„ç†çš„APIè°ƒç”¨
  Future<ApiResult<List<User>>> getUsers() async {
    try {
      final response = await _request.get<Map<String, dynamic>>('/users');
      final users = (response['data'] as List)
          .map((item) => User.fromJson(item))
          .toList();
      
      return ApiResult.success(users);
      
    } on NetworkException catch (e) {
      // ç½‘ç»œå¼‚å¸¸å¤„ç†
      AppLogger.error('Network error: ${e.message}');
      
      switch (e.type) {
        case NetworkExceptionType.timeout:
          return ApiResult.failure('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•');
        case NetworkExceptionType.connectivity:
          return ApiResult.failure('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        case NetworkExceptionType.unauthorized:
          return ApiResult.failure('èº«ä»½éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
        case NetworkExceptionType.serverError:
          return ApiResult.failure('æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
        default:
          return ApiResult.failure(e.message);
      }
    } catch (e) {
      // å…¶ä»–å¼‚å¸¸å¤„ç†
      AppLogger.error('Unexpected error: $e');
      return ApiResult.failure('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
}

/// APIç»“æœå°è£…ç±»
class ApiResult<T> {
  final bool success;
  final T? data;
  final String? error;
  
  ApiResult.success(this.data) : success = true, error = null;
  ApiResult.failure(this.error) : success = false, data = null;
}
```

### 5.2 å¼‚å¸¸æ¢å¤ç”¨ä¾‹

```dart
class RobustController extends GetxController {
  final RxBool isLoading = false.obs;
  final RxString errorMessage = ''.obs;
  
  /// å¸¦é‡è¯•æœºåˆ¶çš„æ•°æ®åŠ è½½
  Future<void> loadDataWithRetry() async {
    int retryCount = 0;
    const maxRetries = 3;
    
    while (retryCount < maxRetries) {
      try {
        isLoading.value = true;
        errorMessage.value = '';
        
        final result = await _loadData();
        
        if (result.success) {
          // æ•°æ®åŠ è½½æˆåŠŸ
          _handleSuccessData(result.data);
          return;
        } else {
          throw Exception(result.error);
        }
        
      } catch (e) {
        retryCount++;
        AppLogger.warning('æ•°æ®åŠ è½½å¤±è´¥ (å°è¯• $retryCount/$maxRetries): $e');
        
        if (retryCount >= maxRetries) {
          // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
          errorMessage.value = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
          _showErrorSnackbar('æ•°æ®åŠ è½½å¤±è´¥');
        } else {
          // ç­‰å¾…åé‡è¯•
          await Future.delayed(Duration(seconds: retryCount * 2));
        }
      } finally {
        isLoading.value = false;
      }
    }
  }
  
  void _showErrorSnackbar(String message) {
    Get.snackbar(
      'é”™è¯¯',
      message,
      snackPosition: SnackPosition.BOTTOM,
      backgroundColor: Colors.red,
      colorText: Colors.white,
    );
  }
}
```

---

## 6. æµ‹è¯•ç”¨ä¾‹

### 6.1 ç½‘ç»œå±‚æµ‹è¯•

```dart
class NetworkTestController extends GetxController {
  final RequestManager _request = RequestManager.instance;
  
  /// æµ‹è¯•åŸºç¡€ç½‘ç»œè¿æ¥
  Future<void> testBasicNetwork() async {
    try {
      AppLogger.info('å¼€å§‹æµ‹è¯•åŸºç¡€ç½‘ç»œè¿æ¥...');
      final data = await _request.get<Map<String, dynamic>>('/status');
      AppLogger.info('ç½‘ç»œè¿æ¥æµ‹è¯•æˆåŠŸ: $data');
    } catch (e) {
      AppLogger.error('ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥: $e');
    }
  }
  
  /// æµ‹è¯•è®¤è¯åŠŸèƒ½
  Future<void> testAuthentication() async {
    try {
      AppLogger.info('å¼€å§‹æµ‹è¯•è®¤è¯åŠŸèƒ½...');
      
      // è®¾ç½®æµ‹è¯•Token
      _request.setAuthToken('test-token-123');
      
      final data = await _request.get<Map<String, dynamic>>('/protected');
      AppLogger.info('è®¤è¯æµ‹è¯•æˆåŠŸ: $data');
      
      // æ¸…é™¤Token
      _request.clearAuthToken();
    } catch (e) {
      AppLogger.error('è®¤è¯æµ‹è¯•å¤±è´¥: $e');
    }
  }
  
  /// æµ‹è¯•ç¼“å­˜åŠŸèƒ½
  Future<void> testCache() async {
    try {
      AppLogger.info('å¼€å§‹æµ‹è¯•ç¼“å­˜åŠŸèƒ½...');
      
      // ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆåº”è¯¥ä»ç½‘ç»œè·å–ï¼‰
      final start1 = DateTime.now();
      await _request.get<Map<String, dynamic>>('/cached-data');
      final duration1 = DateTime.now().difference(start1);
      AppLogger.info('ç¬¬ä¸€æ¬¡è¯·æ±‚è€—æ—¶: ${duration1.inMilliseconds}ms');
      
      // ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”è¯¥ä»ç¼“å­˜è·å–ï¼‰
      final start2 = DateTime.now();
      await _request.get<Map<String, dynamic>>('/cached-data');
      final duration2 = DateTime.now().difference(start2);
      AppLogger.info('ç¬¬äºŒæ¬¡è¯·æ±‚è€—æ—¶: ${duration2.inMilliseconds}ms');
      
      if (duration2.inMilliseconds < duration1.inMilliseconds) {
        AppLogger.info('âœ… ç¼“å­˜åŠŸèƒ½æ­£å¸¸å·¥ä½œ');
      }
    } catch (e) {
      AppLogger.error('ç¼“å­˜æµ‹è¯•å¤±è´¥: $e');
    }
  }
}
```

### 6.2 æœåŠ¡æµ‹è¯•

```dart
class ServiceTestUtil {
  static Future<void> testAllServices() async {
    AppLogger.info('å¼€å§‹æµ‹è¯•æ‰€æœ‰æœåŠ¡...');
    
    await testAppServicesAccess();
    await testLocalStorage();
    await testNetworkService();
    
    AppLogger.info('æ‰€æœ‰æœåŠ¡æµ‹è¯•å®Œæˆ');
  }
  
  static Future<void> testAppServicesAccess() async {
    AppLogger.info('æµ‹è¯•AppServicesè®¿é—®...');
    
    try {
      final localStorage = AppServices.instance.localStorage;
      final userService = AppServices.instance.userService;
      final authRepository = AppServices.instance.authRepository;
      
      assert(localStorage != null);
      assert(userService != null);
      assert(authRepository != null);
      
      AppLogger.info('âœ… AppServicesè®¿é—®æµ‹è¯•æˆåŠŸ');
    } catch (e) {
      AppLogger.error('âŒ æœåŠ¡è®¿é—®æµ‹è¯•å¤±è´¥: $e');
    }
  }
  
  static Future<void> testLocalStorage() async {
    AppLogger.info('æµ‹è¯•æœ¬åœ°å­˜å‚¨...');
    
    try {
      final localStorage = AppServices.instance.localStorage;
      
      // æµ‹è¯•å­—ç¬¦ä¸²å­˜å‚¨
      await localStorage.setString('test_key', 'test_value');
      final value = localStorage.getString('test_key');
      assert(value == 'test_value');
      
      // æµ‹è¯•æ¸…é™¤
      await localStorage.remove('test_key');
      final clearedValue = localStorage.getString('test_key');
      assert(clearedValue == null);
      
      AppLogger.info('âœ… æœ¬åœ°å­˜å‚¨æµ‹è¯•æˆåŠŸ');
    } catch (e) {
      AppLogger.error('âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥: $e');
    }
  }
}
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 è¯·æ±‚å–æ¶ˆ

```dart
class DataController extends GetxController {
  CancelToken? _cancelToken;
  
  Future<void> loadData() async {
    // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    _cancelToken?.cancel();
    _cancelToken = CancelToken();
    
    try {
      final data = await RequestManager.instance.get(
        '/data',
        cancelToken: _cancelToken,
      );
      // å¤„ç†æ•°æ®
    } catch (e) {
      if (!CancelToken.isCancel(e)) {
        // å¤„ç†éå–æ¶ˆé”™è¯¯
      }
    }
  }
  
  @override
  void onClose() {
    _cancelToken?.cancel();
    super.onClose();
  }
}
```

### 7.2 åˆ†é¡µæ•°æ®åŠ è½½

```dart
class PaginatedListController extends GetxController {
  final RxList<dynamic> items = <dynamic>[].obs;
  final RxBool isLoading = false.obs;
  final RxBool hasMore = true.obs;
  
  int _currentPage = 1;
  final int _pageSize = 20;
  
  /// åŠ è½½ç¬¬ä¸€é¡µ
  Future<void> loadFirstPage() async {
    _currentPage = 1;
    items.clear();
    await _loadPage();
  }
  
  /// åŠ è½½æ›´å¤šæ•°æ®
  Future<void> loadMore() async {
    if (!hasMore.value || isLoading.value) return;
    
    _currentPage++;
    await _loadPage();
  }
  
  Future<void> _loadPage() async {
    try {
      isLoading.value = true;
      
      final response = await RequestManager.instance.get<Map<String, dynamic>>(
        '/items',
        queryParameters: {
          'page': _currentPage,
          'page_size': _pageSize,
        },
      );
      
      final newItems = response['data'] as List;
      
      if (_currentPage == 1) {
        items.assignAll(newItems);
      } else {
        items.addAll(newItems);
      }
      
      hasMore.value = newItems.length >= _pageSize;
      
    } catch (e) {
      AppLogger.error('åˆ†é¡µæ•°æ®åŠ è½½å¤±è´¥: $e');
      if (_currentPage > 1) _currentPage--; // å›æ»šé¡µç 
    } finally {
      isLoading.value = false;
    }
  }
}
```

### 7.3 æœç´¢é˜²æŠ–

```dart
class SearchController extends GetxController {
  final TextEditingController searchInput = TextEditingController();
  final RxList<dynamic> searchResults = <dynamic>[].obs;
  final RxBool isSearching = false.obs;
  
  Timer? _debounceTimer;
  
  @override
  void onInit() {
    super.onInit();
    
    // ç›‘å¬æœç´¢è¾“å…¥å˜åŒ–
    searchInput.addListener(_onSearchChanged);
  }
  
  void _onSearchChanged() {
    // å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
    _debounceTimer?.cancel();
    
    // è®¾ç½®é˜²æŠ–å»¶æ—¶
    _debounceTimer = Timer(Duration(milliseconds: 500), () {
      final query = searchInput.text.trim();
      if (query.isNotEmpty) {
        _performSearch(query);
      } else {
        searchResults.clear();
      }
    });
  }
  
  Future<void> _performSearch(String query) async {
    try {
      isSearching.value = true;
      
      final response = await RequestManager.instance.get<Map<String, dynamic>>(
        '/search',
        queryParameters: {'q': query},
      );
      
      searchResults.assignAll(response['data']);
      
    } catch (e) {
      AppLogger.error('æœç´¢å¤±è´¥: $e');
    } finally {
      isSearching.value = false;
    }
  }
  
  @override
  void onClose() {
    _debounceTimer?.cancel();
    searchInput.dispose();
    super.onClose();
  }
}
```

---

## 8. é«˜çº§ç”¨ä¾‹

### 8.1 æµå¼æ•°æ®å¤„ç†

```dart
class StreamDataController extends GetxController {
  final RequestManager _request = RequestManager.instance;
  StreamSubscription? _streamSubscription;
  
  /// å¤„ç†æµå¼æ•°æ®
  Future<void> handleStreamData() async {
    try {
      // è·å–æµå¼å“åº”
      final stream = NetworkClient.instance.getStream(
        '/stream-data',
        headers: {'Accept': 'text/event-stream'},
      );
      
      _streamSubscription = stream.listen(
        (String chunk) {
          _processStreamChunk(chunk);
        },
        onError: (error) {
          AppLogger.error('æµå¼æ•°æ®é”™è¯¯: $error');
        },
        onDone: () {
          AppLogger.info('æµå¼æ•°æ®ä¼ è¾“å®Œæˆ');
        },
      );
      
    } catch (e) {
      AppLogger.error('æµå¼æ•°æ®å¤„ç†å¤±è´¥: $e');
    }
  }
  
  void _processStreamChunk(String chunk) {
    try {
      if (chunk.startsWith('data: ')) {
        final jsonData = chunk.substring(6);
        final data = jsonDecode(jsonData);
        // å¤„ç†å®æ—¶æ•°æ®
        _updateUI(data);
      }
    } catch (e) {
      AppLogger.error('å¤„ç†æµå¼æ•°æ®å—å¤±è´¥: $e');
    }
  }
  
  @override
  void onClose() {
    _streamSubscription?.cancel();
    super.onClose();
  }
}
```

### 8.2 æ‰¹é‡æ“ä½œ

```dart
class BatchOperationController extends GetxController {
  final RequestManager _request = RequestManager.instance;
  
  /// æ‰¹é‡ä¸Šä¼ æ–‡ä»¶
  Future<List<String>> batchUploadFiles(List<File> files) async {
    final uploadedUrls = <String>[];
    final batchSize = 3; // åŒæ—¶ä¸Šä¼ 3ä¸ªæ–‡ä»¶
    
    for (int i = 0; i < files.length; i += batchSize) {
      final batch = files.skip(i).take(batchSize).toList();
      
      final futures = batch.map((file) => _uploadSingleFile(file));
      final results = await Future.wait(futures);
      
      for (final url in results) {
        if (url != null) {
          uploadedUrls.add(url);
        }
      }
      
      // æ›´æ–°è¿›åº¦
      final progress = ((i + batch.length) / files.length * 100).toInt();
      AppLogger.info('æ‰¹é‡ä¸Šä¼ è¿›åº¦: $progress%');
    }
    
    return uploadedUrls;
  }
  
  Future<String?> _uploadSingleFile(File file) async {
    try {
      final formData = FormData.fromMap({
        'file': await MultipartFile.fromFile(file.path),
      });
      
      final response = await _request.upload<Map<String, dynamic>>(
        '/upload',
        formData,
      );
      
      return response['data']['url'];
    } catch (e) {
      AppLogger.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${file.path} - $e');
      return null;
    }
  }
}
```

---

## 9. åæ€ä¸æ€»ç»“

### 9.1 å®Œæ•´æ€§æ£€æŸ¥ âœ…
- âœ… æ¶µç›–äº†æ‰€æœ‰ä¸»è¦åŠŸèƒ½æ¨¡å—çš„ç”¨ä¾‹
- âœ… åŒ…å«äº†ä»åŸºç¡€åˆ°é«˜çº§çš„ä½¿ç”¨åœºæ™¯
- âœ… æä¾›äº†è¯¦ç»†çš„ä»£ç ç¤ºä¾‹å’Œé”™è¯¯å¤„ç†

### 9.2 å‡†ç¡®æ€§éªŒè¯ âœ…
- âœ… æ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½åŸºäºå®é™…é¡¹ç›®æ¶æ„
- âœ… APIè°ƒç”¨æ–¹å¼å’Œé”™è¯¯å¤„ç†ç­–ç•¥å‡†ç¡®
- âœ… æœ€ä½³å®è·µç¬¦åˆFlutterå’ŒDartè§„èŒƒ

### 9.3 å®ç”¨æ€§è¯„ä¼° âœ…
- âœ… æ–‡æ¡£å¯ä½œä¸ºå¼€å‘å›¢é˜Ÿçš„å®é™…å‚è€ƒ
- âœ… æä¾›äº†å¯ç›´æ¥ä½¿ç”¨çš„ä»£ç æ¨¡æ¿
- âœ… æ¶µç›–äº†å¸¸è§çš„ä¸šåŠ¡å¼€å‘åœºæ™¯

### 9.4 æ½œåœ¨æ”¹è¿›å»ºè®®
- ğŸ”§ å¯å¢åŠ æ›´å¤šUIå±‚ä¸ä¸šåŠ¡å±‚äº¤äº’çš„ç”¨ä¾‹
- ğŸ”§ å¯è¡¥å……WebSocketé•¿è¿æ¥çš„ä½¿ç”¨ç¤ºä¾‹
- ğŸ”§ å¯æ·»åŠ å›½é™…åŒ–å’Œä¸»é¢˜åˆ‡æ¢çš„ç”¨ä¾‹

æœ¬åŠŸèƒ½ç”¨ä¾‹æŒ‡å—ä¸ºå¼€å‘å›¢é˜Ÿæä¾›äº†å®Œæ•´çš„æ¡†æ¶ä½¿ç”¨å‚è€ƒï¼Œæ”¯æŒå¿«é€Ÿä¸Šæ‰‹å’Œé«˜æ•ˆå¼€å‘ã€‚
