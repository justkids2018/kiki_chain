# 功能库引用文档

## 1. 核心功能库概览

本项目采用模块化设计，核心功能被封装为独立的工具库和服务层，便于复用和维护。

### 1.1 功能库架构图

```
🛠️ Utils Layer (工具库层)
├── JWT工具库 (jwt.rs)           - JWT令牌生成、验证、提取
├── 通用工具库 (tool.rs)         - 密码哈希、验证等通用功能
└── 错误处理库 (errors.rs)      - 统一错误定义和处理

💼 Application Layer (应用层)
├── 用例库 (use_cases/)         - 业务逻辑编排
├── DTO库 (dto.rs)              - 数据传输对象
└── 命令库 (commands.rs)        - 命令模式实现

🏛️ Domain Layer (领域层)
├── 实体库 (entities.rs)        - 核心业务实体
├── 仓储接口库 (repositories.rs) - 数据访问抽象
└── 值对象库 (value_objects.rs) - 领域值对象

🔧 Infrastructure Layer (基础设施层)
├── 持久化库 (persistence/)     - 数据库访问实现
├── 日志库 (logging.rs)         - 结构化日志系统
└── 配置库 (config/)            - 环境配置管理

🌐 Presentation Layer (表现层)
├── 中间件库 (middleware.rs)    - HTTP中间件集合
├── 控制器库 (controllers/)     - HTTP请求处理
└── 路由库 (routes/)            - 路由配置管理
```

## 2. JWT工具库 (JwtUtils)

### 2.1 功能概述

JWT工具库提供完整的JWT令牌管理功能，支持全应用公共调用。

**文件位置**: `src/utils/jwt.rs`

### 2.2 核心功能

#### 配置管理
```rust
pub struct JwtConfig {
    pub secret: String,        // JWT密钥
    pub expiry_hours: i64,     // 过期时间（小时）
}

// 初始化配置
JwtUtils::init(config: JwtConfig) -> Result<()>
JwtUtils::quick_init() -> Result<()>  // 使用默认配置
```

#### 令牌操作
```rust
// 生成JWT令牌
JwtUtils::generate_token(user: &User) -> Result<String>

// 验证JWT令牌
JwtUtils::verify_token(token: &str) -> Result<Claims>

// 提取用户ID
JwtUtils::extract_user_id(token: &str) -> Result<String>
```

#### Claims结构
```rust
pub struct Claims {
    pub sub: String,     // 用户ID
    pub phone: String,   // 手机号
    pub email: String,   // 邮箱
    pub exp: i64,        // 过期时间
    pub iat: i64,        // 签发时间
}
```

### 2.3 使用示例

```rust
// 初始化JWT配置（应用启动时）
JwtUtils::quick_init()?;

// 生成令牌
let token = JwtUtils::generate_token(&user)?;

// 验证令牌
let claims = JwtUtils::verify_token(&token)?;
println!("用户ID: {}", claims.sub);

// 提取用户ID
let user_id = JwtUtils::extract_user_id(&token)?;
```

### 2.4 依赖项

```toml
[dependencies]
jsonwebtoken = "9.3"
chrono = { version = "0.4", features = ["serde"] }
serde = { version = "1.0", features = ["derive"] }
```

## 3. 通用工具库 (ToolUtils)

### 3.1 功能概述

通用工具库提供密码哈希、验证等常用功能。

**文件位置**: `src/utils/tool.rs`

### 3.2 核心功能

#### 密码管理
```rust
// 哈希密码
ToolUtils::hash_password(password: &str) -> Result<String>

// 验证密码
ToolUtils::verify_password(password: &str, hash: &str) -> Result<bool>
```

### 3.3 实现细节

```rust
use bcrypt::{hash, verify, DEFAULT_COST};

impl ToolUtils {
    pub fn hash_password(password: &str) -> Result<String> {
        hash(password, DEFAULT_COST)
            .map_err(|e| DomainError::Infrastructure(format!("密码哈希失败: {}", e)))
    }
    
    pub fn verify_password(password: &str, hash: &str) -> Result<bool> {
        verify(password, hash)
            .map_err(|e| DomainError::Infrastructure(format!("密码验证失败: {}", e)))
    }
}
```

### 3.4 使用示例

```rust
// 注册时哈希密码
let hashed_password = ToolUtils::hash_password("user_password")?;

// 登录时验证密码
let is_valid = ToolUtils::verify_password("user_password", &stored_hash)?;
if is_valid {
    println!("密码正确");
}
```

### 3.5 依赖项

```toml
[dependencies]
bcrypt = "0.15"
```

## 4. 日志工具库 (Logger)

### 4.1 功能概述

提供结构化JSON日志系统，支持不同级别的日志记录。

**文件位置**: `src/infrastructure/logging.rs`

### 4.2 核心功能

#### 日志级别
```rust
Logger::info(message: &str)           // 信息日志
Logger::warn(message: &str)           // 警告日志
Logger::error(message: &str)          // 错误日志
Logger::startup_info(message: &str)   // 启动信息
```

#### 特殊功能
```rust
Logger::http_error(data: Value)                    // HTTP错误日志
Logger::to_json_value<T: Serialize>(data: T)      // 对象转JSON
```

### 4.3 使用示例

```rust
// 基础日志
Logger::info("用户登录成功");
Logger::warn("密码验证失败");
Logger::error("数据库连接失败");

// 结构化日志
Logger::http_error(json!({
    "status": 401,
    "message": "认证失败",
    "path": "/api/auth/login"
}));
```

## 5. 中间件库 (Middleware)

### 5.1 功能概述

提供完整的HTTP中间件集合，包括认证、日志、错误处理等。

**文件位置**: `src/presentation/http/middleware.rs`

### 5.2 核心中间件

#### JWT认证中间件
```rust
jwt_auth_middleware(request: Request<Body>, next: Next) -> Result<Response>
```

特性：
- 白名单机制
- 自动令牌验证
- 详细日志记录

白名单路径：
- `/api/auth/login`
- `/api/auth/register`
- `/health`

#### 请求响应日志中间件
```rust
request_response_data_log_middleware(request: Request, next: Next) -> Response
```

特性：
- 唯一请求ID
- 敏感数据脱敏
- 性能监控
- 结构化JSON输出

#### 错误处理中间件
```rust
error_handling_middleware(request: Request<Body>, next: Next) -> Response
```

特性：
- 统一错误格式
- 错误状态码映射
- 错误日志记录

#### CORS中间件
```rust
create_cors_layer(allowed_origins: Vec<String>) -> CorsLayer
```

特性：
- 配置化允许域名
- 支持凭证传递
- 完整的HTTP方法支持

### 5.3 中间件使用

```rust
// 在路由中应用中间件栈
Router::new()
    .merge(all_routes)
    .layer(middleware::from_fn(jwt_auth_middleware))
    .layer(middleware::from_fn(error_handling_middleware))
    .layer(middleware::from_fn(request_response_data_log_middleware))
    .layer(cors_layer)
```

## 6. 配置管理库

### 6.1 功能概述

提供环境配置管理，支持多环境配置。

**文件位置**: `src/config/`

### 6.2 配置结构

```rust
// 数据库配置
pub struct DatabaseConfig {
    pub url: String,
    pub max_connections: u32,
}

// 应用配置
pub struct AppConfig {
    pub host: String,
    pub port: u16,
    pub database: DatabaseConfig,
    pub cors_origins: Vec<String>,
}
```

### 6.3 配置文件

```toml
# config/development.toml
[database]
url = "postgresql://localhost/qiqimanyou_dev"
max_connections = 10

[server]
host = "127.0.0.1"
port = 8081

[[cors_origins]]
"http://localhost:3000"
"http://localhost:5173"
```

### 6.4 使用示例

```rust
// 获取配置
let config = get_config()?;
println!("服务器端口: {}", config.port);

// 获取数据库URL
let db_url = config.database_url();
```

## 7. 实体工厂库

### 7.1 功能概述

提供领域实体的创建和重构功能。

**文件位置**: `src/domain/entities.rs`

### 7.2 核心实体

#### User实体
```rust
impl User {
    // 创建新用户
    pub fn new(
        uid: String,
        name: String,
        email: String,
        phone: String,
        pwd: String,
        role_id: i32,
    ) -> Self
    
    // 从数据库重构用户
    pub fn reconstruct(
        id: Uuid,
        uid: String,
        name: String,
        email: String,
        phone: String,
        pwd: String,
        created_at: DateTime<Utc>,
        updated_at: DateTime<Utc>,
        role_id: i32,
    ) -> Self
    
    // 更新时间戳
    pub fn update_timestamp(&mut self)
}
```

### 7.3 使用示例

```rust
// 创建新用户
let user = User::new(
    "teacher_123".to_string(),
    "张三".to_string(),
    "zhangsan@example.com".to_string(),
    "13800138000".to_string(),
    hashed_password,
    3
);

// 更新时间戳
let mut user = existing_user;
user.update_timestamp();
```

## 8. 仓储模式库

### 8.1 功能概述

提供数据访问抽象和实现。

**文件位置**: 
- 接口: `src/domain/repositories.rs`
- 实现: `src/infrastructure/persistence/`

### 8.2 仓储接口

```rust
#[async_trait]
pub trait UserRepository: Send + Sync {
    async fn find_by_phone(&self, phone: &str) -> Result<Option<User>>;
    async fn find_by_email(&self, email: &str) -> Result<Option<User>>;
    async fn save(&self, user: &User) -> Result<()>;
    async fn find_by_id(&self, id: &Uuid) -> Result<Option<User>>;
}
```

### 8.3 使用示例

```rust
// 查找用户
let user = user_repository.find_by_phone("13800138000").await?;

// 保存用户
user_repository.save(&user).await?;
```

## 9. 依赖注入容器

### 9.1 功能概述

统一管理所有依赖关系，实现控制反转。

**文件位置**: `src/app/dependency_container.rs`

### 9.2 容器结构

```rust
pub struct AppState {
    pub auth_controller: Arc<AuthController>,
    pub assignment_controller: Arc<AssignmentController>,
    pub student_controller: Arc<StudentController>,
}

pub struct DependencyContainer {
    pub app_state: AppState,
}
```

### 9.3 初始化流程

```rust
impl DependencyContainer {
    pub fn new(pool: PgPool) -> Self {
        // 1. 初始化工具库
        JwtUtils::quick_init()?;
        
        // 2. 创建仓储实现
        let user_repository = Arc::new(PostgresUserRepository::new(pool.clone()));
        
        // 3. 创建用例
        let login_use_case = Arc::new(LoginUserUseCase::new(user_repository.clone()));
        
        // 4. 创建控制器
        let auth_controller = Arc::new(AuthController::new(
            register_use_case,
            login_use_case
        ));
        
        // 5. 组装应用状态
        let app_state = AppState {
            auth_controller,
            assignment_controller,
            student_controller,
        };
        
        Self { app_state }
    }
}
```

## 10. 使用最佳实践

### 10.1 工具库使用原则

1. **单一职责**: 每个工具库只负责一类功能
2. **无状态设计**: 工具方法应该是无状态的静态方法
3. **错误处理**: 统一使用领域错误类型
4. **可测试性**: 提供易于测试的接口

### 10.2 依赖管理

```rust
// 推荐的依赖注入方式
pub struct LoginUserUseCase {
    user_repository: Arc<dyn UserRepository>,  // 依赖仓储接口
}

// 避免直接依赖具体实现
// ❌ 不推荐
pub struct LoginUserUseCase {
    postgres_repo: PostgresUserRepository,  // 直接依赖实现
}
```

### 10.3 错误处理

```rust
// 统一错误处理
let result = ToolUtils::verify_password(password, hash)
    .map_err(|e| DomainError::Infrastructure(format!("密码验证失败: {}", e)))?;
```

### 10.4 日志记录

```rust
// 结构化日志
Logger::info(&format!("🔍 [{}] {}: {}", "密码验证", "用户ID", user.uid()));

// 避免敏感信息
Logger::info(&format!("密码长度: {}", password.len()));  // ✅ 安全
Logger::info(&format!("密码内容: {}", password));        // ❌ 不安全
```

## 11. 功能库清单

### 11.1 已实现功能库

- ✅ JWT工具库 - 完整实现
- ✅ 密码工具库 - 完整实现  
- ✅ 日志工具库 - 完整实现
- ✅ 中间件库 - 完整实现
- ✅ 配置管理库 - 完整实现
- ✅ 实体工厂库 - 完整实现
- ✅ 仓储模式库 - 完整实现
- ✅ 依赖注入容器 - 完整实现

### 11.2 计划扩展功能库

- 🔄 缓存工具库 - Redis集成
- 🔄 文件上传库 - 多云存储支持
- 🔄 短信发送库 - 多厂商集成
- 🔄 邮件发送库 - SMTP配置
- 🔄 限流工具库 - 分布式限流
- 🔄 数据验证库 - 复杂验证规则

## 12. 总结

本项目的功能库设计遵循以下原则：

1. **模块化**: 每个功能库独立封装，职责明确
2. **可复用**: 工具库可在整个项目中公共调用
3. **可扩展**: 易于添加新功能和替换实现
4. **可测试**: 提供清晰的接口便于单元测试
5. **可维护**: 统一的错误处理和日志记录

这种设计使得项目具有良好的可维护性和扩展性，同时保持了代码的简洁性和可读性。
