# 🌐 Rust 后端服务云上传部署指南

> **生成时间**: 2025-08-13  
> **目标服务器**: 82.156.34.186 (腾讯云)  
> **部署路径**: /home/ubuntu/qisd_eda_college/backend  

## 🚀 云上传部署流程

### 📋 前置检查

#### 1. 本地环境检查
```bash
# 检查 Docker 是否运行
docker --version
docker compose --version

# 检查项目文件
ls -la backend/
cat backend/.env.production
```

#### 2. 服务器连接检查
```bash
# 测试 SSH 连接
ssh ubuntu@82.156.34.186 "echo '连接成功'"

# 检查服务器 Docker 环境
ssh ubuntu@82.156.34.186 "docker --version && docker compose --version"
```

### 🏗️ 镜像构建和上传

#### 步骤 1: 本地构建镜像
```bash
# 进入项目根目录
cd /path/to/qiqimanyou_server

# 执行构建脚本
chmod +x backend/build_image.sh
./backend/build_image.sh

# 验证构建结果
ls -lh backend/qiqimanyou-server-linux-amd64.tar.gz
```

**构建过程说明:**
- ✅ 多阶段构建 (builder + runtime)
- ✅ 强制指定 linux/amd64 架构
- ✅ 自动压缩镜像文件
- ✅ 生成 SHA256 校验值

#### 步骤 2: 上传到服务器
```bash
# 执行上传部署脚本
chmod +x backend/deploy_to_server.sh
./backend/deploy_to_server.sh
```

**上传过程说明:**
- 📤 上传压缩镜像文件
- 📤 上传 Docker Compose 配置
- 📤 上传环境变量配置
- 🔄 自动执行服务器端部署

### 🖥️ 服务器端操作

#### 自动执行的操作
```bash
# 在服务器上自动执行的命令
cd /home/ubuntu/qisd_eda_college/backend

# 1. 解压镜像
gunzip -f qiqimanyou-server-linux-amd64.tar.gz

# 2. 加载镜像
docker load < qiqimanyou-server-linux-amd64.tar

# 3. 停止旧服务
docker compose down

# 4. 启动新服务
docker compose --env-file .env up -d

# 5. 检查服务状态
docker compose ps
```

#### 手动验证操作
```bash
# SSH 登录服务器
ssh ubuntu@82.156.34.186

# 切换到部署目录
cd /home/ubuntu/qisd_eda_college/backend

# 查看服务状态
docker compose ps

# 查看服务日志
docker compose logs -f qiqimanyou-server

# 测试健康检查
curl http://localhost:8001/health
```

## 🔍 部署验证

### 1. 服务状态检查
```bash
# 本地测试 (通过公网)
curl http://82.156.34.186/health

# 预期响应
{
  "status": "healthy",
  "timestamp": "2025-08-13T10:30:00Z",
  "version": "1.0.0"
}
```

### 2. 容器状态检查
```bash
ssh ubuntu@82.156.34.186 '
  cd /home/ubuntu/qisd_eda_college/backend
  docker compose ps
'

# 预期输出
NAME                IMAGE                       STATUS
qiqimanyou-backend  qiqimanyou-server:latest   Up 2 minutes (healthy)
qiqimanyou-postgres postgres:15-alpine         Up 2 minutes (healthy)
qiqimanyou-redis    redis:7-alpine             Up 2 minutes (healthy)
```

### 3. 网络连接检查
```bash
# 检查网络配置
ssh ubuntu@82.156.34.186 '
  docker network ls | grep qiqimanyou
  docker network inspect qiqimanyou-network
'
```

## 📊 上传性能指标

### 典型上传时间
| 镜像大小 | 网络环境 | 上传时间 |
|---------|----------|----------|
| ~200MB  | 家庭宽带 | 3-5分钟  |
| ~200MB  | 企业网络 | 1-2分钟  |
| ~200MB  | 云内网络 | 30-60秒  |

### 优化建议
1. **差量更新**: 使用 Docker 镜像层缓存
2. **压缩上传**: 已启用 gzip 压缩
3. **并行上传**: 可考虑使用 rsync 同步

## 🚨 故障排查

### 常见问题和解决方案

#### 1. 镜像构建失败
```bash
# 问题: Rust 编译错误
# 解决: 检查源代码语法错误

# 问题: 依赖下载失败
# 解决: 检查网络连接，或使用镜像源
```

#### 2. 上传连接失败
```bash
# 问题: SSH 连接超时
# 解决: 检查服务器网络和防火墙

# 问题: SCP 传输中断
# 解决: 使用 rsync 替代，支持断点续传
rsync -avz --progress backend/qiqimanyou-server-linux-amd64.tar.gz ubuntu@82.156.34.186:~/qisd_eda_college/backend/
```

#### 3. 服务启动失败
```bash
# 检查容器日志
ssh ubuntu@82.156.34.186 '
  cd /home/ubuntu/qisd_eda_college/backend
  docker compose logs qiqimanyou-server
'

# 常见原因:
# - 数据库连接失败
# - 环境变量配置错误
# - 端口冲突
# - 健康检查失败
```

#### 4. 健康检查失败
```bash
# 检查应用日志
docker compose logs qiqimanyou-server

# 检查端口监听
netstat -tlnp | grep 8001

# 手动测试健康检查
curl -v http://localhost:8001/health
```

## 🔄 回滚操作

### 快速回滚
```bash
# 停止当前服务
ssh ubuntu@82.156.34.186 '
  cd /home/ubuntu/qisd_eda_college/backend
  docker compose down
'

# 加载之前的镜像
ssh ubuntu@82.156.34.186 '
  docker images | grep qiqimanyou-server
  docker tag qiqimanyou-server:previous qiqimanyou-server:latest
  cd /home/ubuntu/qisd_eda_college/backend
  docker compose up -d
'
```

### 备份策略
```bash
# 部署前备份当前镜像
ssh ubuntu@82.156.34.186 '
  docker tag qiqimanyou-server:latest qiqimanyou-server:backup-$(date +%Y%m%d-%H%M%S)
'

# 备份数据库
ssh ubuntu@82.156.34.186 '
  docker exec qiqimanyou-postgres pg_dump -U qisd edadb > /tmp/backup-$(date +%Y%m%d-%H%M%S).sql
'
```

## 📈 监控和日志

### 日志管理
```bash
# 查看实时日志
ssh ubuntu@82.156.34.186 '
  cd /home/ubuntu/qisd_eda_college/backend
  docker compose logs -f --tail=100
'

# 查看特定服务日志
docker compose logs qiqimanyou-server
docker compose logs postgres
docker compose logs redis
```

### 性能监控
```bash
# 容器资源使用情况
docker stats qiqimanyou-backend

# 系统资源使用情况
ssh ubuntu@82.156.34.186 '
  top
  free -h
  df -h
'
```

## 🛡️ 安全最佳实践

### 1. SSH 密钥管理
```bash
# 确保使用 SSH 密钥而非密码
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
ssh-copy-id ubuntu@82.156.34.186
```

### 2. 服务器安全
```bash
# 检查防火墙状态
ssh ubuntu@82.156.34.186 'ufw status'

# 只开放必要端口
ssh ubuntu@82.156.34.186 '
  ufw allow 22/tcp
  ufw allow 80/tcp
  ufw allow 443/tcp
  ufw enable
'
```

# 端口被占

```
  lsof -i :8081
  kill -9 12345
```

### 3. 容器安全
- ✅ 使用非 root 用户运行容器
- ✅ 定期更新基础镜像
- ✅ 扫描镜像安全漏洞
- ✅ 限制容器资源使用

## 🎯 生产环境检查清单

### 部署前检查
- [ ] 本地镜像构建成功
- [ ] 环境变量配置正确
- [ ] SSH 连接正常
- [ ] 服务器磁盘空间充足
- [ ] 数据库备份完成

### 部署后检查
- [ ] 健康检查端点响应正常
- [ ] 所有容器状态为 healthy
- [ ] 日志无错误信息
- [ ] API 接口可正常访问
- [ ] 数据库连接正常

### 性能检查
- [ ] 响应时间在可接受范围内
- [ ] 内存使用率正常
- [ ] CPU 使用率正常
- [ ] 磁盘 I/O 正常

---

📝 **最后更新**: 2025-08-13  
🔗 **相关文档**: [部署文档](部署文档_20250813.md) | [API 文档] | [监控文档]  
📞 **技术支持**: 遇到问题请参考故障排查章节或联系技术团队
