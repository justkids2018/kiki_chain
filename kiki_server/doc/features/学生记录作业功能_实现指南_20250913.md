# 学生记录作业功能_实现指南_20250913

## 1. 结论摘要
- 引入独立的学生作业模块，覆盖创建、查询、更新、删除完整流程。
- 在 Domain / Application / Infrastructure / Presentation 四层新增实现，复用既有仓储与日志体系。
- 新增 REST 路由 `/api/student-assignments`，统一对外暴露学生作业管理接口。

## 2. 前提与假设
- 数据库已存在 `student_assignments` 表结构，列字段以 `doc/sql/00-create-all-tables.sql` 为准。
- 依赖注入容器 `AppState` 可注入新的控制器实例，不影响现有业务。
- 调用方通过 JWT 认证后访问接口；本迭代不改动认证流程。
- 分数字段允许小数，输入精度控制交由调用方。

## 3. 设计方案
- **domain/student_assignment**：新增 `StudentAssignmentFactory` / `StudentAssignmentUpdater`，负责实体创建与领域校验，扩展 `StudentAssignment` 实体的状态、统计字段 setter。
- **repositories**：扩充 `StudentAssignmentRepository` 接口 (`find_by_id`、`delete`)，`PostgresStudentAssignmentRepository` 完成 CRUD SQL。
- **application/use_cases/student_assignment**：
  - `CreateStudentAssignmentUseCase` 解析命令->领域数据->持久化。
  - `Get`/`List` 用例按条件查询，提供 `StudentAssignmentView` DTO。
  - `Update` 用例支持可选字段、显式清空（`Option<Option<_>>`）。
  - `Delete` 用例校验存在性后删除。
- **presentation/http/student_assignment_controller**：将 JSON 请求转换为命令/查询，封装 `ApiResponse`，统一日志输出。
- **app 层**：新增 `StudentAssignmentControllerFactory`、路由模块 `routes/student_assignment`，`ApiPaths` 增加路径常量，`DependencyContainer` 注入新控制器并接入主路由。

## 4. 设计模式分析
- **工厂模式**：`StudentAssignmentFactory` 封装实体构建逻辑，遵循 SRP/OCP。
- **命令/查询对象**：用例层使用 `Command`/`Query` DTO，将 HTTP 层与领域层解耦，符合 DIP。
- **控制器工厂**：保持依赖注入容器职责单一，通过组合复用，实现 CRP。
- **替代方案**：可用 Builder 代替 Factory，但当前字段有限，工厂更轻量；亦可复用现有 `student` 控制器，但为避免影响旧链路而选择新模块。

## 5. 代码变更
```diff
+ src/domain/student_assignment/mod.rs
+ src/application/use_cases/student_assignment/{create_,get_,list_,update_,delete_}student_assignment.rs
+ src/application/use_cases/student_assignment/dto.rs
+ src/presentation/http/student_assignment_controller.rs
+ src/app/factories/student_assignment_controller_factory.rs
+ src/app/routes/student_assignment.rs
```
- 扩展接口与实体：`src/domain/entities.rs:300` 起新增 setter；`src/domain/repositories.rs:50`、`src/domain/assignment_repositories.rs:28` 增加 `find_by_id`、`delete`。
- 基础设施实现：`src/infrastructure/persistence/postgres_assignment_repositories.rs:170` 引入查询/删除 SQL。
- 应用总线：`src/application/use_cases/mod.rs:6` 暴露新模块。
- 路由与容器：`src/app/api_paths.rs:22`、`src/app/dependency_container.rs:31`、`src/app/routes/main_routes.rs:25` 注册新控制器与路由。
- 表现层导出：`src/presentation/http/mod.rs:8` 新增学生作业控制器导出。

## 6. 功能使用实例
```http
POST /api/student-assignments
{
  "assignment_id": "9d0b4b61-4c43-4b54-b7d4-9e5a9e7f1234",
  "student_id": "stu_001",
  "status": "in_progress",
  "dialog_rounds": 2,
  "avg_thinking_time_ms": 1500,
  "knowledge_mastery_score": 88.5,
  "thinking_depth_score": 90.0,
  "conversation_id": "conv_001"
}
```
- 成功返回 `ApiResponse.success`，`data` 为学生作业视图 JSON。
- `GET /api/student-assignments?student_id=stu_001&status=completed` 可筛选记录。
- `PUT /api/student-assignments/{id}` 支持可选字段更新，`conversation_id: null` 表示清空。
- `DELETE /api/student-assignments/{id}` 删除指定记录。

## 7. 测试用例
- `cargo test --lib`：新增 4 个用例覆盖创建、查询过滤、更新清空、删除流程。
- Doc 测试 `src/utils/http.rs` 仍需补全示例导入（历史问题）。

## 8. 回滚与迁移方案
- 若需回滚，可删除 `student_assignment` 目录与相关路由/工厂注入，并回退 `StudentAssignmentRepository` 新增方法。
- 数据库无结构变更，无需迁移脚本。

## 9. 风险与未决问题
- 目前未对分数阈值做上限校验，需与产品确认范围。
- 接口未包含分页参数，若数据量大需补充。
- 与既有 `/api/student/{student_id}/assignments` 路径共存，需后续统一。

## 10. 待确认问题
1. 是否需要在创建时校验 `assignment_id` 与 `student_id` 存在性？
2. 分数字段的精度/取值范围是否需要额外约束？
3. 是否保留旧学生路由中的 TODO 接口或迁移到新模块？

## 11. 反思检查清单
- ✅ 完整性：覆盖 CRUD、依赖注入、路由、文档。
- ✅ 准确性：SQL 与实体字段对齐，错误处理统一。
- ✅ 实用性：提供实际接口示例与 DTO。
- ✅ 可测试性：新增单元测试覆盖核心路径。
- ✅ 一致性：命名、注释遵循项目规范。
- ✅ 设计合理性：符合 DDD 分层与依赖倒置。
