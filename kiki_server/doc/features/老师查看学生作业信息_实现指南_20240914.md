# 老师查看学生作业信息_实现指南_20240914

## 1. 结论摘要
- 新增 `teacher_assignment` 独立模块，提供老师维度的学生作业聚合查询。
- 贯通 Domain / Application / Infrastructure / Presentation / App 各层，暴露 REST 接口 `/api/teachers/{teacher_uid}/student-assignments`。
- 查询结果包含学生基础信息（含手机号）及其全部作业快照（含作业标题），确保与前端展示需求对齐。

## 2. 前提与假设
- 数据表 `teacher_students`、`users`、`student_assignments` 结构保持与 `doc/sql/00-create-all-tables.sql` 一致。
- 老师与学生关联关系已存在，查询时不做权限校验；认证流程复用现有 JWT 中间件。
- 学生手机号存放于 `users.phone` 字段，未额外做脱敏处理。

## 3. 设计方案
- **Domain**：`src/domain/teacher_assignment/mod.rs` 定义学生基础信息、作业快照及聚合结构，以及查询仓储抽象 `TeacherAssignmentQueryRepository`。
- **Infrastructure**：`PostgresTeacherAssignmentQueryRepository` 通过单条 SQL JOIN 四张表（含 `assignments`），构造领域聚合；对字段缺失/解析错误统一封装 `DomainError::Infrastructure`。
- **Application**：`GetTeacherStudentAssignmentsUseCase` 校验 `teacher_uid`，调用仓储返回聚合，再转换为 DTO（包含手机号）；附带内存仓储单元测试覆盖成功与参数校验分支。
- **Presentation**：`TeacherAssignmentController` 将 URL 参数映射为查询命令，返回 `ApiResponse` 标准结构。
- **App 层**：新增控制器工厂、路由模块与依赖注入；在主路由 `create_routes` 中注册新路由。

## 4. 设计模式分析
- **聚合根模式**：以学生为聚合根，聚合多条作业快照，满足 SRP 并便于后续扩展。(SRP, ISP)
- **仓储模式**：抽象老师作业查询仓储，基础设施实现负责 SQL，遵循 DIP。(DIP, OCP)
- **控制器工厂**：通过工厂集中装配依赖，保持依赖注入容器职责清晰。(SRP)
- **替代方案**：可在 `teacher_student` 模块复用查询逻辑，但会破坏模块边界；亦可拆分多次查询，代价是增加网络开销与一致性风险。
- **文本结构图**：`TeacherAssignmentController -> GetTeacherStudentAssignmentsUseCase -> TeacherAssignmentQueryRepository (trait) -> PostgresTeacherAssignmentQueryRepository`。

## 5. 代码变更
```diff
+ src/domain/teacher_assignment/mod.rs
+ src/application/use_cases/teacher_assignment/{dto.rs,get_teacher_student_assignments.rs,mod.rs}
+ src/infrastructure/persistence/postgres_teacher_assignment_repository.rs
+ src/presentation/http/teacher_assignment_controller.rs
+ src/app/factories/teacher_assignment_controller_factory.rs
+ src/app/routes/teacher_assignment.rs
```
- 新增导出与依赖注入：`src/domain/mod.rs`、`src/application/use_cases/mod.rs`、`src/infrastructure/persistence/mod.rs`、`src/presentation/http/mod.rs`、`src/app/factories/mod.rs`、`src/app/api_paths.rs`、`src/app/dependency_container.rs`、`src/app/routes/{mod.rs,main_routes.rs}`。

## 6. 功能使用实例 ✅
```bash
curl -H "Authorization: Bearer <token>" \
  https://host/api/teachers/teacher_001/student-assignments
```
返回示例（截断）：
```json
{
  "success": true,
  "data": {
    "teacher_uid": "teacher_001",
    "students": [
      {
        "student": {
          "uid": "stu_1001",
          "name": "张三",
          "phone": "18800000000",
          "role_id": 3
        },
        "assignments": [
          {
            "student_assignment_id": "...",
            "assignment_id": "...",
            "assignment_title": "数学思维练习",
            "status": "completed",
            "dialog_rounds": 5,
            "avg_thinking_time_ms": 1200,
            "knowledge_mastery_score": "95",
            "thinking_depth_score": "88",
            "started_at": "2024-09-01T08:00:00Z",
            "completed_at": "2024-09-01T09:00:00Z"
          }
        ]
      }
    ]
  },
  "message": "老师学生作业查询成功"
}
```

## 7. 测试用例
- `cargo test get_teacher_student_assignments`：覆盖成功路径与参数校验失败场景。
- 建议纳入集成测试以验证真实数据库结果与权限控制（待后续补充）。

## 8. 回滚与迁移方案
- 回滚时删除 `teacher_assignment` 相关目录与文件，并恢复 `AppState`、路由、依赖注入修改。
- 数据库无 Schema 变更，无需执行迁移脚本。

## 9. 风险与未决问题
- 若学生数量大，当前无分页，需关注响应体大小和性能。
- 手机号直接透出，若需脱敏/权限控制需追加需求确认。
- SQL 基于多表 JOIN，需确保相应索引存在以避免全表扫描。

## 10. 待确认问题（≤3 条）
1. 是否需要分页/过滤条件（例如按作业状态）？
2. 手机号是否需要脱敏或权限控制？
3. 是否需要追加老师信息（姓名/手机号）以供前端展示？

## 11. 反思检查清单
- ✅ 完整性：覆盖四层代码、接口、文档。
- ✅ 准确性：SQL 字段与领域模型一一对应。
- ✅ 实用性：提供实际调用示例与响应结构。
- ✅ 可测试性：已有单元测试，建议后续补充集成测试。
- ✅ 一致性：模块命名与注释风格遵循既有规范。
- ✅ 设计合理性：遵循 DDD、SOLID，避免跨模块耦合。
