# QiQiManyou Flutter Web éƒ¨ç½²æ–‡æ¡£_20250812

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

- **é¡¹ç›®åç§°**: QiQiManyou Flutter Web åº”ç”¨
- **æŠ€æœ¯æ ˆ**: Flutter Web + Nginx + Docker + PostgreSQL
- **ç›®æ ‡ç¯å¢ƒ**: è…¾è®¯äº‘ Linux AMD64
- **åŸŸå**: http://keepthinking.me
- **ç”Ÿæˆæ—¶é—´**: 2025å¹´8æœˆ12æ—¥
- **ç‰¹ç‚¹**: ä½¿ç”¨æœ¬åœ° Flutter SDKï¼Œæ— éœ€ä¸‹è½½

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ åŸŸåè§£æ â†’ Nginxåå‘ä»£ç† â†’ Flutter Webåº”ç”¨
                                    â†“
                              APIè¯·æ±‚è½¬å‘ â†’ åç«¯æœåŠ¡ â†’ PostgreSQLæ•°æ®åº“
```

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
frontend/
â”œâ”€â”€ Dockerfile                    # ç”Ÿäº§ç¯å¢ƒDockeræ–‡ä»¶
â”œâ”€â”€ nginx.conf                   # Nginxé…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml           # å®Œæ•´æœåŠ¡ç¼–æ’
â”œâ”€â”€ build_deploy_local.sh        # ä¸€é”®æ„å»ºéƒ¨ç½²è„šæœ¬
â””â”€â”€ docker-exports/              # é•œåƒå¯¼å‡ºç›®å½•
    â”œâ”€â”€ kikichain-flutter-web_linux_amd64_*.tar.gz  # å‹ç¼©é•œåƒæ–‡ä»¶
    â”œâ”€â”€ deploy_to_server.sh       # æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬
    â””â”€â”€ upload_to_server.sh       # ä¸Šä¼ è„šæœ¬
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æµç¨‹

### æ–¹å¼ä¸€ï¼šä¸€é”®è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# 1. è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd /Users/qisd/Documents/development/qiqimanyouji/kikichain

# 2. æ‰§è¡Œä¸€é”®æ„å»ºéƒ¨ç½²è„šæœ¬
./frontend/build_deploy_local.sh
```

**è„šæœ¬è‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š**
- âœ… ç¯å¢ƒæ£€æŸ¥ï¼ˆFlutterã€Dockerï¼‰
- âœ… ä½¿ç”¨æœ¬åœ°Flutter SDKæ„å»ºWebåº”ç”¨
- âœ… æ„å»ºLinux AMD64 Dockeré•œåƒ
- âœ… æœ¬åœ°æµ‹è¯•éªŒè¯
- âœ… ä¿å­˜å¹¶å‹ç¼©é•œåƒ
- âœ… ç”ŸæˆæœåŠ¡å™¨éƒ¨ç½²è„šæœ¬
- âœ… ç”Ÿæˆä¸Šä¼ å‘½ä»¤

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨åˆ†æ­¥éƒ¨ç½²

#### æ­¥éª¤1ï¼šæœ¬åœ°Flutteræ„å»º

```bash
# å®‰è£…ä¾èµ–
flutter pub get

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
flutter build web --release --web-renderer canvaskit \
  --dart-define=API_BASE_URL=http://keepthinking.me \
  --dart-define=APP_ENV=production
```

#### æ­¥éª¤2ï¼šæ„å»ºDockeré•œåƒ

```bash
# æ„å»ºæ”¯æŒLinux AMD64çš„é•œåƒ
docker build --platform linux/amd64 \
  --tag kikichain-flutter-web:latest \
  --file frontend/Dockerfile .
```

#### æ­¥éª¤3ï¼šä¿å­˜é•œåƒ

```bash
# åˆ›å»ºå¯¼å‡ºç›®å½•
mkdir -p frontend/docker-exports

# ä¿å­˜å¹¶å‹ç¼©é•œåƒ
docker save kikichain-flutter-web:latest | \
  gzip > frontend/docker-exports/kikichain-flutter-web_$(date +%Y%m%d_%H%M%S).tar.gz
```

## ğŸŒ æœåŠ¡å™¨éƒ¨ç½²

### 1. ä¸Šä¼ æ–‡ä»¶åˆ°è…¾è®¯äº‘æœåŠ¡å™¨

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ç”Ÿæˆçš„ä¸Šä¼ è„šæœ¬
./frontend/docker-exports/upload_to_server.sh

# æ–¹å¼äºŒï¼šæ‰‹åŠ¨ä¸Šä¼ 
SERVER_USER="root"
SERVER_HOST="keepthinking.me"
SERVER_PATH="/opt/kikichain"

# ä¸Šä¼ é•œåƒæ–‡ä»¶
scp frontend/docker-exports/kikichain-flutter-web_*.tar.gz \
  ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/

# ä¸Šä¼ éƒ¨ç½²è„šæœ¬
scp frontend/docker-exports/deploy_to_server.sh \
  ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/

# ä¸Šä¼ é…ç½®æ–‡ä»¶
scp frontend/docker-compose.yml ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
```

### 2. æœåŠ¡å™¨ç«¯éƒ¨ç½²

```bash
# è¿æ¥åˆ°è…¾è®¯äº‘æœåŠ¡å™¨
ssh root@keepthinking.me

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/kikichain

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
chmod +x deploy_to_server.sh
./deploy_to_server.sh
```

### 3. ä½¿ç”¨Docker Composeéƒ¨ç½²å®Œæ•´æœåŠ¡æ ˆ

```bash
# åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨docker-composeéƒ¨ç½²
cd /opt/kikichain
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f flutter-web
```

## ğŸ”§ é…ç½®è¯´æ˜

### Dockeré•œåƒç‰¹æ€§

- **åŸºç¡€é•œåƒ**: nginx:alpine (è½»é‡çº§ï¼Œå®‰å…¨)
- **æ¶æ„æ”¯æŒ**: linux/amd64
- **æ—¶åŒº**: Asia/Shanghai
- **è¿è¡Œç”¨æˆ·**: nginx (érootç”¨æˆ·)
- **å¥åº·æ£€æŸ¥**: 30ç§’é—´éš”æ£€æŸ¥
- **ç«¯å£**: 80 (HTTP)

### Nginxé…ç½®ç‰¹æ€§

- **é™æ€æ–‡ä»¶æœåŠ¡**: é«˜æ•ˆçš„é™æ€èµ„æºæ‰˜ç®¡
- **åå‘ä»£ç†**: APIè¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡
- **ç¼“å­˜ç­–ç•¥**: é™æ€èµ„æºé•¿æœŸç¼“å­˜
- **å‹ç¼©**: Gzipå‹ç¼©å‡å°‘ä¼ è¾“å¤§å°
- **å®‰å…¨å¤´éƒ¨**: XSSä¿æŠ¤ã€å†…å®¹ç±»å‹ä¿æŠ¤ç­‰
- **SPAæ”¯æŒ**: å•é¡µåº”ç”¨è·¯ç”±æ”¯æŒ

### Docker ComposeæœåŠ¡

1. **flutter-web**: å‰ç«¯WebæœåŠ¡ (ç«¯å£80)
2. **kikichain-server**: åç«¯APIæœåŠ¡ (ç«¯å£8001)
3. **postgres**: PostgreSQLæ•°æ®åº“ (ç«¯å£5432)

## ğŸ” ç›‘æ§å’Œæ•…éšœæ’é™¤

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker ps

# æ£€æŸ¥ç‰¹å®šå®¹å™¨
docker ps | grep kikichain

# æ£€æŸ¥åº”ç”¨å“åº”
curl -I http://keepthinking.me/

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs kikichain-production-frontend
```

### å¸¸è§é—®é¢˜è§£å†³

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs --details kikichain-production-frontend

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
docker images | grep kikichain-flutter-web

# é‡æ–°åŠ è½½é•œåƒ
docker load < kikichain-flutter-web_*.tar.gz
```

#### 2. Flutteræ„å»ºå¤±è´¥

```bash
# æ£€æŸ¥Flutterç¯å¢ƒ
flutter doctor

# æ¸…ç†æ„å»ºç¼“å­˜
flutter clean
flutter pub get

# é‡æ–°æ„å»º
flutter build web --release
```

#### 3. ç½‘ç»œè¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :80

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
ufw status

# æ£€æŸ¥Dockerç½‘ç»œ
docker network ls
docker network inspect kikichain-network
```

#### 4. æƒé™é—®é¢˜

```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /usr/share/nginx/html/

# ä¿®å¤æƒé™
docker exec kikichain-production-frontend \
  chown -R nginx:nginx /usr/share/nginx/html
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. é•œåƒä¼˜åŒ–

- âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»º (å¦‚éœ€è¦)
- âœ… ä½¿ç”¨alpineåŸºç¡€é•œåƒ
- âœ… æœ€å°åŒ–é•œåƒå±‚æ•°
- âœ… æ¸…ç†æ„å»ºç¼“å­˜

### 2. Nginxä¼˜åŒ–

- âœ… å¯ç”¨gzipå‹ç¼©
- âœ… é…ç½®é€‚å½“çš„ç¼“å­˜ç­–ç•¥
- âœ… ä¼˜åŒ–workerè¿›ç¨‹é…ç½®
- âœ… å¯ç”¨HTTP/2 (å¦‚é…ç½®SSL)

### 3. Flutter Webä¼˜åŒ–

- âœ… ä½¿ç”¨CanvasKitæ¸²æŸ“å™¨
- âœ… å¯ç”¨Tree Shaking
- âœ… å‹ç¼©èµ„æºæ–‡ä»¶
- âœ… é…ç½®é€‚å½“çš„ç¼“å­˜å¤´

## ğŸ”’ å®‰å…¨é…ç½®

### 1. Nginxå®‰å…¨å¤´éƒ¨

```nginx
add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";
add_header X-XSS-Protection "1; mode=block";
add_header Referrer-Policy "strict-origin-when-cross-origin";
```

### 2. Dockerå®‰å…¨

- âœ… ä½¿ç”¨érootç”¨æˆ·è¿è¡Œ
- âœ… æœ€å°æƒé™åŸåˆ™
- âœ… å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ
- âœ… æ‰«æé•œåƒæ¼æ´

### 3. ç½‘ç»œå®‰å…¨

- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
- âœ… ä½¿ç”¨ç§æœ‰ç½‘ç»œ
- âœ… å®šæœŸæ›´æ–°SSLè¯ä¹¦ (å¦‚é…ç½®HTTPS)

## ğŸ“ˆ æ‰©å±•å’Œç»´æŠ¤

### 1. æ°´å¹³æ‰©å±•

```yaml
# docker-compose.ymlæ‰©å±•é…ç½®
flutter-web:
  deploy:
    replicas: 3
    update_config:
      parallelism: 1
      delay: 10s
```

### 2. æŒç»­éƒ¨ç½²

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
git pull origin main
./frontend/build_deploy_local.sh
```

### 3. å¤‡ä»½ç­–ç•¥

```bash
# é•œåƒå¤‡ä»½
docker save kikichain-flutter-web:latest | \
  gzip > backup/kikichain-$(date +%Y%m%d).tar.gz

# é…ç½®æ–‡ä»¶å¤‡ä»½
tar -czf backup/configs-$(date +%Y%m%d).tar.gz \
  frontend/nginx.conf frontend/docker-compose.yml
```

## ğŸ¯ éªŒè¯éƒ¨ç½²æˆåŠŸ

### 1. åŠŸèƒ½éªŒè¯

```bash
# ä¸»é¡µè®¿é—®æµ‹è¯•
curl -v http://keepthinking.me/

# å¥åº·æ£€æŸ¥æµ‹è¯•
docker exec kikichain-production-frontend curl -f http://localhost/

# APIä»£ç†æµ‹è¯•
curl -v http://keepthinking.me/api/health
```

### 2. æ€§èƒ½éªŒè¯

```bash
# å“åº”æ—¶é—´æµ‹è¯•
curl -w "è¿æ¥æ—¶é—´: %{time_connect}s, æ€»æ—¶é—´: %{time_total}s\n" \
  -o /dev/null -s http://keepthinking.me/

# å‹ç¼©æµ‹è¯•
curl -H "Accept-Encoding: gzip" -I http://keepthinking.me/
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å…³é”®æ–‡ä»¶ä½ç½®

- **é¡¹ç›®æ ¹ç›®å½•**: `/Users/qisd/Documents/development/qiqimanyouji/kikichain`
- **æ„å»ºè„šæœ¬**: `frontend/build_deploy_local.sh`
- **é…ç½®æ–‡ä»¶**: `frontend/nginx.conf`, `frontend/docker-compose.yml`
- **éƒ¨ç½²æ–‡æ¡£**: `frontend/éƒ¨ç½²æ–‡æ¡£_20250812.md`

### ç¯å¢ƒè¦æ±‚

- **æœ¬åœ°ç¯å¢ƒ**: macOS + Flutter 3.7.12 + Docker Desktop
- **æœåŠ¡å™¨ç¯å¢ƒ**: Ubuntu/Debian + Docker + Docker Compose
- **ç½‘ç»œè¦æ±‚**: æ”¯æŒSSHè¿æ¥å’ŒHTTPè®¿é—®

### ç´§æ€¥å¤„ç†

å¦‚é‡ç´§æ€¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹æ–‡æ¡£ï¼š
- `EMERGENCY_FIX_GUIDE.md`
- `PROBLEM_SOLVED.md`
- Dockeræ—¥å¿—: `docker logs kikichain-production-frontend`

---

**éƒ¨ç½²å®Œæˆåè®¿é—®åœ°å€**: http://keepthinking.me

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025å¹´8æœˆ12æ—¥  
**é€‚ç”¨ç¯å¢ƒ**: è…¾è®¯äº‘ç”Ÿäº§ç¯å¢ƒ (Linux AMD64)
