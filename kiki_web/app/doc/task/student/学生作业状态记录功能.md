## 角色
你是Flutter 高级开发工程师，具有丰富的DDD架构和GetX状态管理经验，UI设计功能

## 任务目标
优化学生作业状态记录功能，实现智能记录管理

### 核心功能需求

#### 1. 学生作业记录管理优化
**当前问题**：
- `_createStudentAssignmentRecord` 方法直接创建记录，可能导致重复记录
- 每次点击作业卡片都会创建新记录，无法正确追踪对话轮次

**优化方案**：
- 封装 `_createStudentAssignmentRecord` 为查询 + 创建/更新的复合流程，命名 `_manageStudentAssignmentRecord`
- 先通过 `StudentAssignmentNoteRepository.getStudentAssignmentRecord(assignmentId, studentId)` 查询是否存在记录
- 如果没有记录：调用 `createStudentAssignmentRecord` 创建新记录，`dialogRounds` 取调用方传入的初始值（默认 1）
- 如果有记录：调用 `updateStudentAssignmentRecord` 更新现有记录，`dialogRounds` = 原记录的 `dialogRounds` + 调用方传入的增量（默认为 1）
- 更新记录时同时刷新 `updatedAt` 字段，保留原 `status` 和 `startedAt`
- 确保每个学生每个作业只有一条记录，正确累计对话次数，避免重复创建

#### 2. 业务逻辑流程
```
点击作业卡片 → 调用 _manageStudentAssignmentRecord()
                ↓
         查询现有记录 (assignmentId + studentId)
                ↓
    ┌─────────────────────────────────────┐
    ↓                                     ↓
记录不存在                            记录已存在
    ↓                                     ↓
创建新记录                            更新记录
dialogRounds = 1                      dialogRounds += 1
status = inProgress                   保持原状态
startedAt = now()                     更新 updatedAt
```

#### 3. 数据状态管理
- 记录创建时机：首次点击作业卡片时
- 记录更新时机：再次点击同一作业卡片时
- 状态跟踪：通过 dialogRounds 记录学生与作业的交互次数
- 时间记录：startedAt（首次开始时间）、updatedAt（最后更新时间）

## 实现状态

### ✅ 已完成的功能

#### 1. StudentAssignmentEntity 数据模型优化
- ✅ 添加 `evaluationMetrics` 字段（Map<String, dynamic>类型）
- ✅ 支持API文档中的四个评估指标：
  - `three_student_rate`: 三重学生率
  - `three_proposition_quality`: 三重命题质量  
  - `two_student_chain`: 二重学生链
  - `two_cover_rate`: 二重覆盖率
- ✅ 更新 fromJson、toJson、copyWith、toString 方法

#### 2. 学生作业记录管理优化
- ✅ 重构 `_createStudentAssignmentRecord` 为 `_manageStudentAssignmentRecord`
- ✅ 实现查询-创建或更新逻辑：
  - 先查询现有记录（根据 assignmentId + studentId）
  - 无记录时：创建新记录，dialogRounds = 1
  - 有记录时：更新记录，dialogRounds = 原值 + 1
- ✅ 正确处理 dialogRounds 可能为 null 的情况
- ✅ 保持错误处理的静默模式，不影响主流程

#### 3. Repository 查询方法
- ✅ 确认 `getStudentAssignmentByStudentAndAssignment` 方法已存在
- ✅ 方法支持根据学生ID和作业ID查询唯一记录

### 🎯 优化效果

#### 业务逻辑改进
- **避免重复记录**：每个学生每个作业只保持一条记录
- **正确计数**：dialogRounds 字段准确反映学生与作业的交互次数  
- **数据完整性**：支持完整的评估指标数据结构

#### 代码质量提升
- **方法语义化**：方法名从 create 改为 manage，更准确反映实际功能
- **空值安全**：正确处理 dialogRounds 可能为 null 的边界情况
- **日志完善**：详细记录操作过程，便于调试和监控

#### API 兼容性
- **完整支持**：StudentAssignmentEntity 完全支持 API 文档定义的数据结构
- **向后兼容**：新增字段为可选，不影响现有功能

## 已知上下文
📑 接口文档参考
• 学生作业模块 → doc/api/backend_api_documentation.md


## 约束与规范

### 开发架构规范
• 所有基础开发要求需动态读取：doc/prompt/base_*.md
• 必须遵循团队开发指南：doc/framework/新功能开发指南标准_20250916.md  
• 使用GetX状态管理，Controller放在独立controllers目录
• 数据模型放在独立models目录
• 业务逻辑通过services层处理
• 集成现有RequestManager进行API调用
• 请求的返回结果使用  ApiResponseException  和 ApiResponseHandler，结构化响应数据


### UI 设计规范
• 样式、颜色、布局遵循：doc/prompt/ui_prompt_info.md
• 居中模态对话框设计
• 每个输入字段包含删除图标功能
• 字符计数显示
• 统一的错误提示样式
• 按钮禁用/启用状态视觉反馈

### **功能独立性**（核心原则）：
   - 功能完全独立，不依赖现有逻辑  
   - 不修改任何现有文件，只新增独立模块
   - 通过参数控制集成，不海取现有流程
   - 单独的服务层、控制器、组件，保证模块化
   - 可以独立开发、测试、部署，不影响原有功能

### 关键技术点
  **完全独立性**：新功能零依赖现有聊天，可独立开发和部署

### 实现要求：
明确禁止模拟代码："不要使用任何模拟、延迟或假数据"
要求具体实现："必须调用真实的API方法"
要求测试验证："提供可验证的调试日志"
明确成功标准："应该能看到真实的API响应"
