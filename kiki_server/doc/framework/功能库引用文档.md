# åŠŸèƒ½åº“å¼•ç”¨æ–‡æ¡£

## 1. æ ¸å¿ƒåŠŸèƒ½åº“æ¦‚è§ˆ

æœ¬é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ ¸å¿ƒåŠŸèƒ½è¢«å°è£…ä¸ºç‹¬ç«‹çš„å·¥å…·åº“å’ŒæœåŠ¡å±‚ï¼Œä¾¿äºå¤ç”¨å’Œç»´æŠ¤ã€‚

### 1.1 åŠŸèƒ½åº“æ¶æ„å›¾

```
ğŸ› ï¸ Utils Layer (å·¥å…·åº“å±‚)
â”œâ”€â”€ JWTå·¥å…·åº“ (jwt.rs)           - JWTä»¤ç‰Œç”Ÿæˆã€éªŒè¯ã€æå–
â”œâ”€â”€ é€šç”¨å·¥å…·åº“ (tool.rs)         - å¯†ç å“ˆå¸Œã€éªŒè¯ç­‰é€šç”¨åŠŸèƒ½
â””â”€â”€ é”™è¯¯å¤„ç†åº“ (errors.rs)      - ç»Ÿä¸€é”™è¯¯å®šä¹‰å’Œå¤„ç†

ğŸ’¼ Application Layer (åº”ç”¨å±‚)
â”œâ”€â”€ ç”¨ä¾‹åº“ (use_cases/)         - ä¸šåŠ¡é€»è¾‘ç¼–æ’
â”œâ”€â”€ DTOåº“ (dto.rs)              - æ•°æ®ä¼ è¾“å¯¹è±¡
â””â”€â”€ å‘½ä»¤åº“ (commands.rs)        - å‘½ä»¤æ¨¡å¼å®ç°

ğŸ›ï¸ Domain Layer (é¢†åŸŸå±‚)
â”œâ”€â”€ å®ä½“åº“ (entities.rs)        - æ ¸å¿ƒä¸šåŠ¡å®ä½“
â”œâ”€â”€ ä»“å‚¨æ¥å£åº“ (repositories.rs) - æ•°æ®è®¿é—®æŠ½è±¡
â””â”€â”€ å€¼å¯¹è±¡åº“ (value_objects.rs) - é¢†åŸŸå€¼å¯¹è±¡

ğŸ”§ Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)
â”œâ”€â”€ æŒä¹…åŒ–åº“ (persistence/)     - æ•°æ®åº“è®¿é—®å®ç°
â”œâ”€â”€ æ—¥å¿—åº“ (logging.rs)         - ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ
â””â”€â”€ é…ç½®åº“ (config/)            - ç¯å¢ƒé…ç½®ç®¡ç†

ğŸŒ Presentation Layer (è¡¨ç°å±‚)
â”œâ”€â”€ ä¸­é—´ä»¶åº“ (middleware.rs)    - HTTPä¸­é—´ä»¶é›†åˆ
â”œâ”€â”€ æ§åˆ¶å™¨åº“ (controllers/)     - HTTPè¯·æ±‚å¤„ç†
â””â”€â”€ è·¯ç”±åº“ (routes/)            - è·¯ç”±é…ç½®ç®¡ç†
```

## 2. JWTå·¥å…·åº“ (JwtUtils)

### 2.1 åŠŸèƒ½æ¦‚è¿°

JWTå·¥å…·åº“æä¾›å®Œæ•´çš„JWTä»¤ç‰Œç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒå…¨åº”ç”¨å…¬å…±è°ƒç”¨ã€‚

**æ–‡ä»¶ä½ç½®**: `src/utils/jwt.rs`

### 2.2 æ ¸å¿ƒåŠŸèƒ½

#### é…ç½®ç®¡ç†
```rust
pub struct JwtConfig {
    pub secret: String,        // JWTå¯†é’¥
    pub expiry_hours: i64,     // è¿‡æœŸæ—¶é—´ï¼ˆå°æ—¶ï¼‰
}

// åˆå§‹åŒ–é…ç½®
JwtUtils::init(config: JwtConfig) -> Result<()>
JwtUtils::quick_init() -> Result<()>  // ä½¿ç”¨é»˜è®¤é…ç½®
```

#### ä»¤ç‰Œæ“ä½œ
```rust
// ç”ŸæˆJWTä»¤ç‰Œ
JwtUtils::generate_token(user: &User) -> Result<String>

// éªŒè¯JWTä»¤ç‰Œ
JwtUtils::verify_token(token: &str) -> Result<Claims>

// æå–ç”¨æˆ·ID
JwtUtils::extract_user_id(token: &str) -> Result<String>
```

#### Claimsç»“æ„
```rust
pub struct Claims {
    pub sub: String,     // ç”¨æˆ·ID
    pub phone: String,   // æ‰‹æœºå·
    pub email: String,   // é‚®ç®±
    pub exp: i64,        // è¿‡æœŸæ—¶é—´
    pub iat: i64,        // ç­¾å‘æ—¶é—´
}
```

### 2.3 ä½¿ç”¨ç¤ºä¾‹

```rust
// åˆå§‹åŒ–JWTé…ç½®ï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰
JwtUtils::quick_init()?;

// ç”Ÿæˆä»¤ç‰Œ
let token = JwtUtils::generate_token(&user)?;

// éªŒè¯ä»¤ç‰Œ
let claims = JwtUtils::verify_token(&token)?;
println!("ç”¨æˆ·ID: {}", claims.sub);

// æå–ç”¨æˆ·ID
let user_id = JwtUtils::extract_user_id(&token)?;
```

### 2.4 ä¾èµ–é¡¹

```toml
[dependencies]
jsonwebtoken = "9.3"
chrono = { version = "0.4", features = ["serde"] }
serde = { version = "1.0", features = ["derive"] }
```

## 3. é€šç”¨å·¥å…·åº“ (ToolUtils)

### 3.1 åŠŸèƒ½æ¦‚è¿°

é€šç”¨å·¥å…·åº“æä¾›å¯†ç å“ˆå¸Œã€éªŒè¯ç­‰å¸¸ç”¨åŠŸèƒ½ã€‚

**æ–‡ä»¶ä½ç½®**: `src/utils/tool.rs`

### 3.2 æ ¸å¿ƒåŠŸèƒ½

#### å¯†ç ç®¡ç†
```rust
// å“ˆå¸Œå¯†ç 
ToolUtils::hash_password(password: &str) -> Result<String>

// éªŒè¯å¯†ç 
ToolUtils::verify_password(password: &str, hash: &str) -> Result<bool>
```

### 3.3 å®ç°ç»†èŠ‚

```rust
use bcrypt::{hash, verify, DEFAULT_COST};

impl ToolUtils {
    pub fn hash_password(password: &str) -> Result<String> {
        hash(password, DEFAULT_COST)
            .map_err(|e| DomainError::Infrastructure(format!("å¯†ç å“ˆå¸Œå¤±è´¥: {}", e)))
    }
    
    pub fn verify_password(password: &str, hash: &str) -> Result<bool> {
        verify(password, hash)
            .map_err(|e| DomainError::Infrastructure(format!("å¯†ç éªŒè¯å¤±è´¥: {}", e)))
    }
}
```

### 3.4 ä½¿ç”¨ç¤ºä¾‹

```rust
// æ³¨å†Œæ—¶å“ˆå¸Œå¯†ç 
let hashed_password = ToolUtils::hash_password("user_password")?;

// ç™»å½•æ—¶éªŒè¯å¯†ç 
let is_valid = ToolUtils::verify_password("user_password", &stored_hash)?;
if is_valid {
    println!("å¯†ç æ­£ç¡®");
}
```

### 3.5 ä¾èµ–é¡¹

```toml
[dependencies]
bcrypt = "0.15"
```

## 4. æ—¥å¿—å·¥å…·åº“ (Logger)

### 4.1 åŠŸèƒ½æ¦‚è¿°

æä¾›ç»“æ„åŒ–JSONæ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•ã€‚

**æ–‡ä»¶ä½ç½®**: `src/infrastructure/logging.rs`

### 4.2 æ ¸å¿ƒåŠŸèƒ½

#### æ—¥å¿—çº§åˆ«
```rust
Logger::info(message: &str)           // ä¿¡æ¯æ—¥å¿—
Logger::warn(message: &str)           // è­¦å‘Šæ—¥å¿—
Logger::error(message: &str)          // é”™è¯¯æ—¥å¿—
Logger::startup_info(message: &str)   // å¯åŠ¨ä¿¡æ¯
```

#### ç‰¹æ®ŠåŠŸèƒ½
```rust
Logger::http_error(data: Value)                    // HTTPé”™è¯¯æ—¥å¿—
Logger::to_json_value<T: Serialize>(data: T)      // å¯¹è±¡è½¬JSON
```

### 4.3 ä½¿ç”¨ç¤ºä¾‹

```rust
// åŸºç¡€æ—¥å¿—
Logger::info("ç”¨æˆ·ç™»å½•æˆåŠŸ");
Logger::warn("å¯†ç éªŒè¯å¤±è´¥");
Logger::error("æ•°æ®åº“è¿æ¥å¤±è´¥");

// ç»“æ„åŒ–æ—¥å¿—
Logger::http_error(json!({
    "status": 401,
    "message": "è®¤è¯å¤±è´¥",
    "path": "/api/auth/login"
}));
```

## 5. ä¸­é—´ä»¶åº“ (Middleware)

### 5.1 åŠŸèƒ½æ¦‚è¿°

æä¾›å®Œæ•´çš„HTTPä¸­é—´ä»¶é›†åˆï¼ŒåŒ…æ‹¬è®¤è¯ã€æ—¥å¿—ã€é”™è¯¯å¤„ç†ç­‰ã€‚

**æ–‡ä»¶ä½ç½®**: `src/presentation/http/middleware.rs`

### 5.2 æ ¸å¿ƒä¸­é—´ä»¶

#### JWTè®¤è¯ä¸­é—´ä»¶
```rust
jwt_auth_middleware(request: Request<Body>, next: Next) -> Result<Response>
```

ç‰¹æ€§ï¼š
- ç™½åå•æœºåˆ¶
- è‡ªåŠ¨ä»¤ç‰ŒéªŒè¯
- è¯¦ç»†æ—¥å¿—è®°å½•

ç™½åå•è·¯å¾„ï¼š
- `/api/auth/login`
- `/api/auth/register`
- `/health`

#### è¯·æ±‚å“åº”æ—¥å¿—ä¸­é—´ä»¶
```rust
request_response_data_log_middleware(request: Request, next: Next) -> Response
```

ç‰¹æ€§ï¼š
- å”¯ä¸€è¯·æ±‚ID
- æ•æ„Ÿæ•°æ®è„±æ•
- æ€§èƒ½ç›‘æ§
- ç»“æ„åŒ–JSONè¾“å‡º

#### é”™è¯¯å¤„ç†ä¸­é—´ä»¶
```rust
error_handling_middleware(request: Request<Body>, next: Next) -> Response
```

ç‰¹æ€§ï¼š
- ç»Ÿä¸€é”™è¯¯æ ¼å¼
- é”™è¯¯çŠ¶æ€ç æ˜ å°„
- é”™è¯¯æ—¥å¿—è®°å½•

#### CORSä¸­é—´ä»¶
```rust
create_cors_layer(allowed_origins: Vec<String>) -> CorsLayer
```

ç‰¹æ€§ï¼š
- é…ç½®åŒ–å…è®¸åŸŸå
- æ”¯æŒå‡­è¯ä¼ é€’
- å®Œæ•´çš„HTTPæ–¹æ³•æ”¯æŒ

### 5.3 ä¸­é—´ä»¶ä½¿ç”¨

```rust
// åœ¨è·¯ç”±ä¸­åº”ç”¨ä¸­é—´ä»¶æ ˆ
Router::new()
    .merge(all_routes)
    .layer(middleware::from_fn(jwt_auth_middleware))
    .layer(middleware::from_fn(error_handling_middleware))
    .layer(middleware::from_fn(request_response_data_log_middleware))
    .layer(cors_layer)
```

## 6. é…ç½®ç®¡ç†åº“

### 6.1 åŠŸèƒ½æ¦‚è¿°

æä¾›ç¯å¢ƒé…ç½®ç®¡ç†ï¼Œæ”¯æŒå¤šç¯å¢ƒé…ç½®ã€‚

**æ–‡ä»¶ä½ç½®**: `src/config/`

### 6.2 é…ç½®ç»“æ„

```rust
// æ•°æ®åº“é…ç½®
pub struct DatabaseConfig {
    pub url: String,
    pub max_connections: u32,
}

// åº”ç”¨é…ç½®
pub struct AppConfig {
    pub host: String,
    pub port: u16,
    pub database: DatabaseConfig,
    pub cors_origins: Vec<String>,
}
```

### 6.3 é…ç½®æ–‡ä»¶

```toml
# config/development.toml
[database]
url = "postgresql://localhost/qiqimanyou_dev"
max_connections = 10

[server]
host = "127.0.0.1"
port = 8081

[[cors_origins]]
"http://localhost:3000"
"http://localhost:5173"
```

### 6.4 ä½¿ç”¨ç¤ºä¾‹

```rust
// è·å–é…ç½®
let config = get_config()?;
println!("æœåŠ¡å™¨ç«¯å£: {}", config.port);

// è·å–æ•°æ®åº“URL
let db_url = config.database_url();
```

## 7. å®ä½“å·¥å‚åº“

### 7.1 åŠŸèƒ½æ¦‚è¿°

æä¾›é¢†åŸŸå®ä½“çš„åˆ›å»ºå’Œé‡æ„åŠŸèƒ½ã€‚

**æ–‡ä»¶ä½ç½®**: `src/domain/entities.rs`

### 7.2 æ ¸å¿ƒå®ä½“

#### Userå®ä½“
```rust
impl User {
    // åˆ›å»ºæ–°ç”¨æˆ·
    pub fn new(
        uid: String,
        name: String,
        email: String,
        phone: String,
        pwd: String,
        role_id: i32,
    ) -> Self
    
    // ä»æ•°æ®åº“é‡æ„ç”¨æˆ·
    pub fn reconstruct(
        id: Uuid,
        uid: String,
        name: String,
        email: String,
        phone: String,
        pwd: String,
        created_at: DateTime<Utc>,
        updated_at: DateTime<Utc>,
        role_id: i32,
    ) -> Self
    
    // æ›´æ–°æ—¶é—´æˆ³
    pub fn update_timestamp(&mut self)
}
```

### 7.3 ä½¿ç”¨ç¤ºä¾‹

```rust
// åˆ›å»ºæ–°ç”¨æˆ·
let user = User::new(
    "teacher_123".to_string(),
    "å¼ ä¸‰".to_string(),
    "zhangsan@example.com".to_string(),
    "13800138000".to_string(),
    hashed_password,
    3
);

// æ›´æ–°æ—¶é—´æˆ³
let mut user = existing_user;
user.update_timestamp();
```

## 8. ä»“å‚¨æ¨¡å¼åº“

### 8.1 åŠŸèƒ½æ¦‚è¿°

æä¾›æ•°æ®è®¿é—®æŠ½è±¡å’Œå®ç°ã€‚

**æ–‡ä»¶ä½ç½®**: 
- æ¥å£: `src/domain/repositories.rs`
- å®ç°: `src/infrastructure/persistence/`

### 8.2 ä»“å‚¨æ¥å£

```rust
#[async_trait]
pub trait UserRepository: Send + Sync {
    async fn find_by_phone(&self, phone: &str) -> Result<Option<User>>;
    async fn find_by_email(&self, email: &str) -> Result<Option<User>>;
    async fn save(&self, user: &User) -> Result<()>;
    async fn find_by_id(&self, id: &Uuid) -> Result<Option<User>>;
}
```

### 8.3 ä½¿ç”¨ç¤ºä¾‹

```rust
// æŸ¥æ‰¾ç”¨æˆ·
let user = user_repository.find_by_phone("13800138000").await?;

// ä¿å­˜ç”¨æˆ·
user_repository.save(&user).await?;
```

## 9. ä¾èµ–æ³¨å…¥å®¹å™¨

### 9.1 åŠŸèƒ½æ¦‚è¿°

ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œå®ç°æ§åˆ¶åè½¬ã€‚

**æ–‡ä»¶ä½ç½®**: `src/app/dependency_container.rs`

### 9.2 å®¹å™¨ç»“æ„

```rust
pub struct AppState {
    pub auth_controller: Arc<AuthController>,
    pub assignment_controller: Arc<AssignmentController>,
    pub student_controller: Arc<StudentController>,
}

pub struct DependencyContainer {
    pub app_state: AppState,
}
```

### 9.3 åˆå§‹åŒ–æµç¨‹

```rust
impl DependencyContainer {
    pub fn new(pool: PgPool) -> Self {
        // 1. åˆå§‹åŒ–å·¥å…·åº“
        JwtUtils::quick_init()?;
        
        // 2. åˆ›å»ºä»“å‚¨å®ç°
        let user_repository = Arc::new(PostgresUserRepository::new(pool.clone()));
        
        // 3. åˆ›å»ºç”¨ä¾‹
        let login_use_case = Arc::new(LoginUserUseCase::new(user_repository.clone()));
        
        // 4. åˆ›å»ºæ§åˆ¶å™¨
        let auth_controller = Arc::new(AuthController::new(
            register_use_case,
            login_use_case
        ));
        
        // 5. ç»„è£…åº”ç”¨çŠ¶æ€
        let app_state = AppState {
            auth_controller,
            assignment_controller,
            student_controller,
        };
        
        Self { app_state }
    }
}
```

## 10. ä½¿ç”¨æœ€ä½³å®è·µ

### 10.1 å·¥å…·åº“ä½¿ç”¨åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªå·¥å…·åº“åªè´Ÿè´£ä¸€ç±»åŠŸèƒ½
2. **æ— çŠ¶æ€è®¾è®¡**: å·¥å…·æ–¹æ³•åº”è¯¥æ˜¯æ— çŠ¶æ€çš„é™æ€æ–¹æ³•
3. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€ä½¿ç”¨é¢†åŸŸé”™è¯¯ç±»å‹
4. **å¯æµ‹è¯•æ€§**: æä¾›æ˜“äºæµ‹è¯•çš„æ¥å£

### 10.2 ä¾èµ–ç®¡ç†

```rust
// æ¨èçš„ä¾èµ–æ³¨å…¥æ–¹å¼
pub struct LoginUserUseCase {
    user_repository: Arc<dyn UserRepository>,  // ä¾èµ–ä»“å‚¨æ¥å£
}

// é¿å…ç›´æ¥ä¾èµ–å…·ä½“å®ç°
// âŒ ä¸æ¨è
pub struct LoginUserUseCase {
    postgres_repo: PostgresUserRepository,  // ç›´æ¥ä¾èµ–å®ç°
}
```

### 10.3 é”™è¯¯å¤„ç†

```rust
// ç»Ÿä¸€é”™è¯¯å¤„ç†
let result = ToolUtils::verify_password(password, hash)
    .map_err(|e| DomainError::Infrastructure(format!("å¯†ç éªŒè¯å¤±è´¥: {}", e)))?;
```

### 10.4 æ—¥å¿—è®°å½•

```rust
// ç»“æ„åŒ–æ—¥å¿—
Logger::info(&format!("ğŸ” [{}] {}: {}", "å¯†ç éªŒè¯", "ç”¨æˆ·ID", user.uid()));

// é¿å…æ•æ„Ÿä¿¡æ¯
Logger::info(&format!("å¯†ç é•¿åº¦: {}", password.len()));  // âœ… å®‰å…¨
Logger::info(&format!("å¯†ç å†…å®¹: {}", password));        // âŒ ä¸å®‰å…¨
```

## 11. åŠŸèƒ½åº“æ¸…å•

### 11.1 å·²å®ç°åŠŸèƒ½åº“

- âœ… JWTå·¥å…·åº“ - å®Œæ•´å®ç°
- âœ… å¯†ç å·¥å…·åº“ - å®Œæ•´å®ç°  
- âœ… æ—¥å¿—å·¥å…·åº“ - å®Œæ•´å®ç°
- âœ… ä¸­é—´ä»¶åº“ - å®Œæ•´å®ç°
- âœ… é…ç½®ç®¡ç†åº“ - å®Œæ•´å®ç°
- âœ… å®ä½“å·¥å‚åº“ - å®Œæ•´å®ç°
- âœ… ä»“å‚¨æ¨¡å¼åº“ - å®Œæ•´å®ç°
- âœ… ä¾èµ–æ³¨å…¥å®¹å™¨ - å®Œæ•´å®ç°

### 11.2 è®¡åˆ’æ‰©å±•åŠŸèƒ½åº“

- ğŸ”„ ç¼“å­˜å·¥å…·åº“ - Redisé›†æˆ
- ğŸ”„ æ–‡ä»¶ä¸Šä¼ åº“ - å¤šäº‘å­˜å‚¨æ”¯æŒ
- ğŸ”„ çŸ­ä¿¡å‘é€åº“ - å¤šå‚å•†é›†æˆ
- ğŸ”„ é‚®ä»¶å‘é€åº“ - SMTPé…ç½®
- ğŸ”„ é™æµå·¥å…·åº“ - åˆ†å¸ƒå¼é™æµ
- ğŸ”„ æ•°æ®éªŒè¯åº“ - å¤æ‚éªŒè¯è§„åˆ™

## 12. æ€»ç»“

æœ¬é¡¹ç›®çš„åŠŸèƒ½åº“è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **æ¨¡å—åŒ–**: æ¯ä¸ªåŠŸèƒ½åº“ç‹¬ç«‹å°è£…ï¼ŒèŒè´£æ˜ç¡®
2. **å¯å¤ç”¨**: å·¥å…·åº“å¯åœ¨æ•´ä¸ªé¡¹ç›®ä¸­å…¬å…±è°ƒç”¨
3. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œæ›¿æ¢å®ç°
4. **å¯æµ‹è¯•**: æä¾›æ¸…æ™°çš„æ¥å£ä¾¿äºå•å…ƒæµ‹è¯•
5. **å¯ç»´æŠ¤**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

è¿™ç§è®¾è®¡ä½¿å¾—é¡¹ç›®å…·æœ‰è‰¯å¥½çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„ç®€æ´æ€§å’Œå¯è¯»æ€§ã€‚
